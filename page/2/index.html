<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  
    <meta name="keywords" content="jiaozhengkui">
  
  
    <meta name="description" content="焦正奎的博客">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    
    焦正奎的博客</title>
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">
  
  <script src="/js/pace.min.js"></script>
</head>
</html>
<body>
<main class="content">
  <section class="jumbotron">
  <div class="video">
    
      <div class="video-frame">
        <img src="/images/ocean/overlay-hero.png" alt="Decorative image frame">
      </div>
    
    <div class="video-media">
      <video playsinline autoplay loop muted data-autoplay poster="/images/ocean/ocean.png" x5-video-player-type="h5">
        <source src="/images/ocean/ocean.mp4" type="video/mp4">
        <source src="/images/ocean/ocean.ogv" type="video/ogg">
        <source src="/images/ocean/ocean.webm" type="video/webm">
        <p>Your user agent does not support the HTML5 Video element.</p>
      </video>
      <div class="video-overlay"></div>
    </div>
    <div class="video-inner text-center text-white">
      <h1><a href="/">焦正奎的博客</a></h1>
      <p>不要怕！不要悔！慢慢来！</p>
      <div><img src="/images/hexo-inverted.svg" class="brand" alt="焦正奎的博客"></div>
    </div>
    <div class="video-learn-more">
      <a class="anchor" href="#landingpage"><i class="fe fe-mouse"></i></a>
    </div>
  </div>
</section>

<div id="landingpage">
  <section class="outer">
    <article class="articles">
      
      <h1 class="page-type-title"></h1>
      
        
          <article id="post-曾国藩家书" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

    <div class="article-inner">
        
            <header class="article-header">
                
  
    <h2 itemprop="name">
      <a class="article-title" href="/2018/01/31/曾国藩家书/">曾国藩家书</a>
    </h2>
  
  




            </header>
            

                
                    <div class="article-meta">
                        <a href="/2018/01/31/曾国藩家书/" class="article-date">
  <time datetime="2018-01-30T16:32:54.000Z" itemprop="datePublished">2018-01-31</time>
</a>
                            
  <div class="article-category">
    <a class="article-category-link" href="/categories/读书/">读书</a>
  </div>

                    </div>
                    

                        

                                    <div class="article-entry" itemprop="articleBody">
                                        


                                            

                                                
                                                                    <ol>
<li>每夜早眠，起亦渐早</li>
<li>节劳，节欲，节饮食，谨当时时省记</li>
<li>君子之立志也，有民胞物与之量，有内圣外王之业，而后不忝于父母之所生，不愧为天地之完人</li>
<li>明德新民止至善，皆我分内事也</li>
<li>格物，致知之事也。诚意，力行之事也</li>
<li>倭艮峰先生则诚意工夫极严，每日有日课册。一日之中，一念之差，一事之失，一言一默，皆笔之于书，书皆楷字。三月则订一本，自乙未年起，今三十本矣。</li>
<li>盖明师益友，重重夹持，能进不能退也。</li>
<li>大抵第一要除骄傲气习，中无所有，而夜郎自大，此最坏事</li>
<li>须有志有恒，乃有成就耳</li>
<li>进德，则孝弟仁义是也；修业，则诗文作字是也。此二者由我作主，得尺则我之尺也，得寸则我之寸也。今日进一分德，便算积了一升谷；明日修一分业，又算馀了一文钱；德业并增，则家私日起</li>
<li>吾人为学，最要虚心</li>
<li>故吾人用功，力除傲气，力戒自满，毋为人所冷笑，乃有进步也</li>
<li>凡遇牢骚欲发之时，则反躬自思，吾果有何不足，而蓄此不平之气，猛然内省，决然去之</li>
<li>不宜露头角于外</li>
<li>劝宜息心忍耐</li>
<li>弟性褊急似余，恐拂郁或生肝疾，幸息心忍耐为要</li>
<li>古之成大事者，规模远大与综理密微，二者阙一不可</li>
<li>等差不紊，行之可久，斯则器局宏大，无有流弊者耳。</li>
<li>保养身体，肝郁最伤人</li>
<li>凡人作一事，便须全副精神往在此一事，首尾不懈。不可见异思迁，做这样想那样，坐这山望那山。人而无恒①，终身一无所成</li>
<li>带勇之法，以体察人才为第一，整顿营规、讲求战守次之</li>
<li>身体虽弱，却不宜过于爱惜。精神愈用则愈出，阳气愈提则愈盛。每日作事愈多，则夜间临睡愈快活。若存一爱惜精神的意思，将前将却，奄奄无气，决难成事</li>
<li>古来言凶德致败者约有二端：曰长傲，曰多言</li>
<li>凡心中不可有所恃，心有所恃则达于面貌</li>
<li>注意平和二字</li>
<li>大抵胸中抑郁，怨天尤人，不特不可以涉世，亦非所以养德，不待无以养德，亦非所以保身。中年以后，则肝肾交受其苟，尽郁而不畅则伤木，心火站烁则伤水</li>
<li>故于两弟时时以平和二字相勖③，幸勿视为老生常谈，至嘱至嘱！</li>
<li>家中后辈子弟，体弱学射，最足保养，起早尤千金妙方，长寿金丹也</li>
<li>早起乃健身之妙方</li>
<li>骄矜之气，兹为可虑</li>
<li>宜平骄矜之气</li>
<li>婉陈而切谏之</li>
<li>总以除傲字为第一义，</li>
<li>须戒傲惰二字</li>
<li>力戒傲字，以儆无恒之弊，近来又力戒惰字。</li>
<li>非傲即惰，二者必居其一。</li>
<li>保养之法，亦惟在慎饮食，节嗜欲，断不在多服药也</li>
<li>凡畏人不敢妄议论者，谨慎者也。凡好讥评人短者，骄傲者也</li>
<li>志得意满，毫无畏忌，开口议人短长，即是极骄傲耳</li>
<li>言戒骄字，以不轻非笑人①为第一义</li>
<li>日中则昃，月盈则亏，</li>
<li>管子云：“斗斜满则人概③之，人满则天概之。”余谓天概之无形，仍假手于人以概之。</li>
<li>从古帝王将相，无人不由自强自立做出</li>
<li>近来见得天地之道，刚柔互用，不用偏废，太柔则靡①，太刚则折，刚非暴戾之谓也，强矫而已。柔非卑弱之谓也，谦退而已。趋事赴公，则当强矫，争名逐利，则当谦退，开创家业，则当强矫，守成安乐，则当谦退。出与人物应接，则当强矫，入与妻即享受，则当谦退</li>
<li>有则改之，无则加勉</li>
<li>名望所在，是非于是乎出，赏罚于是乎人，</li>
<li>有才者仇疑谤之无因，因悍然不顾，则谤且日腾。有筏者畏疑谤之无因，而抑然自修，则谤亦日息</li>
<li>吾在外日久，阅事日多，每劝人以不服药为上策。</li>
<li>治心以广大二字为药，治身以不药二字为药。</li>
<li>余阅历已久，觉有病时，断不可吃药，无病时，可偶服补剂调理，亦不可多。</li>
<li>家训，惟早起务农疏医远巫四者，尤为切要</li>
<li>盛时常作衰时想，上场念下场时，</li>
<li>总宜奖其所长，而兼规其短，</li>
<li>吾家于本县父母官，不必力赞其贤，不可力低其非，与之相处，宜在若远若近，不亲不疏之间。渠子侄若与官相见，总以谦谨二字为主。</li>
<li>宜刻刻勤劳，早作夜思，以求有济</li>
<li>吾兄弟但在积劳二字上着力，成名二字，则不必问及，享福二字，则更不必问矣。</li>
<li>将万事看空，毋恼毋怒</li>
<li>心肝两家之病，究以自养自医为主，非药物所能为力</li>
<li>凡郁怒最易伤人，</li>
<li>宜于平日请求养身之法，不可于临时乱投药剂。</li>
<li>内疾外症，果然好了几分。凡属抑郁发怒，最伤身体。我有过错，弟弟尽可一一直说。忌嫉</li>
<li>养身之法，约有一事：一曰眠食有恒①。二曰惩忿，三曰节欲，四曰每夜临睡洗脚，五曰每日两饭后，各行三千步。惩忿即余篇中所谓养生以少恼怒为本也</li>
<li>凡家道所以可久者，不恃一时之官爵，而恃长远之家规，不恃一二人之骤发，而恃大众之维持</li>
<li>望吾弟专在作田上用工，辅之以书蔬鱼猪、早扫考宝八字，任凭家中如何贵盛、切莫全改道光初年之规模</li>
<li>吾辈在自修处求强则可，在胜人处求强则不可。若专在胜人处求强，其能强到底与否，尚未可知，即使终身强横安稳，亦君子所不屑道也。</li>
<li>大悔大悟之后，乃知自己全无本领，凡事都见得人家有几分是处</li>
<li>大约以能立能达为体，以不怨不尤为用。立者，发奋自强，站得住也。达者，办事圆融，行得通也</li>
<li>吾九年以来，痛戒无恒之弊，看书写字，从未间断，选将练兵，亦常留心，此皆自强能立工夫。奏疏公牍，再三斟酌，无一过当之语，自夸之辞，此皆圆融能达工夫。至于怨天本有所不敢，尤人则尚不能免，亦皆随时强制而克去之</li>
<li>惟有处处泰然，行所无事，申甫所谓好汉打脱牙和血吞，星冈公所谓有福之人善退财，真处逆境者之良法也。</li>
<li>只有逆来顺受之法</li>
<li>朱子尝言：“悔字如春，万物蕴蓄初发。吉字如夏，万物茂盛已极。吝字如秋，万物如落。凶字如冬，万物初调。”又尝以元字配春，享字配夏，利字配秋，贞字配冬，兄意贞字即硬字诀也</li>
<li>写字养神。</li>
<li>些小得失不足患，特患业之不精耳。</li>
<li>然科名有无迟早，总由前定，丝毫不能勉强。吾辈读书，只有两事，一者进德之事，讲求乎诚正修齐⑤之道，以图无忝⑥所生，一者修业之事，操习乎记诵词章之术，以图自卫其身。</li>
<li>吾辈读书，只有两事，一者进德之事，讲求乎诚正修齐⑤之道，以图无忝⑥所生，一者修业之事，操习乎记诵词章之术，以图自卫其身。</li>
<li>求业之精，别无他法，曰专而已矣。谚曰：“艺多不养身，谓不专也。”吾掘井多而无泉可饮，不专之咎也！</li>
<li>凡专一业之人，必有心得，亦必有疑义。诸</li>
<li>诸弟每日自立课程，必须有日日不断之功，虽行船走路，须带在身边</li>
<li>要皆有志之上，不甘居于庸碌者也。</li>
<li>天下有益之事，即有足损者寓乎其中，不可不辨。</li>
<li>有志则断不敢为下流，有识则知学问无尽，不敢以一得自足，如河伯之观海，如井蛙之窥天，皆无识也。有恒则断无不成之事，此三者，缺一不可</li>
<li>附课程表 　　</li>
</ol>
<ul>
<li>一、主敬、整齐严肃、无时不俱，无事时心在腔子里，应事时专一不杂。</li>
<li>二、静坐、每日不拘何时，静坐一会，体验静极生阳来复之仁心，正位凝命，如鼎之锁。</li>
<li>三、早起、黎明即起，醒后勿沾恋。</li>
<li>四、读书不二、一书未点完，断不看他书，东翻西阅，都是徇外⑦为人。</li>
<li>五、读史、廿三史每日读十页，虽有事，不间断。</li>
<li>六、写日记、须端谐，凡日问过恶，身过，心过，口过，皆己出，终身不间断。</li>
<li>七、日知其所亡⑧、每日记茶余偶谈一则，分德行门，学问门，经济门，艺术门。</li>
<li>八、月无忘所能、每月作诗文数首，以验积理之金寡，气之盛否。</li>
<li>九、谨言、刻刻留心。</li>
<li>十、养气、无不可对人言之事，气藏丹田。</li>
<li>十一、保身、谨遵大人手谕，节欲，节劳，节饮食。</li>
<li>十二、作字、早饭后作字，凡笔墨应酬，当作自己功课。</li>
<li>十三、夜不出门、旷功疲神，切戒切戒！</li>
</ul>
<ol start="83">
<li>为人子者，若使父母见得我好些，谓诸兄弟俱不及我，这便是不孝，若使族党称道我好些，谓诸兄弟俱不如我，这便是不梯①，何也？盖使父母心中有贤愚之分，使族党②口中有贤愚之分，则必其平日有讨好底意思，暗用机计，使自己得好名声，而使兄弟得坏名声，必其后日之嫌隙，由此而生也</li>
<li>取明师之益，无受损友之损也</li>
<li>无恒者见异思迁</li>
<li>穷经必专一经，不可泛骛</li>
<li>有一耐字诀，一句不通，不看下句，今日不通，明日再读，今年不通，明年再读，此所谓耐</li>
<li>读经以研寻义理为本，考据名物为末，读至有一耐字诀，一句不通，不看下句，今日不通，明日再读，今年不通，明年再读，此所谓耐也</li>
<li>读史之法，莫妙于设身处地，每看一处，如我便与当时之人，酬酢笑语于其间。不必人人皆能记也。但记一人，则恍如接其人，不必事事皆能记也。但记一事，则恍如亲其事，经以穷理，史以考事，舍此二者。更别无学矣。</li>
<li>此一集未读完，断断不换他集，亦专字诀也</li>
<li>读经读史读专集，讲义理之学，此有志者万不可易者也</li>
<li>于兄弟出直达其隐，父子祖孙间，不得不曲致其情。</li>
<li>若果威仪可则，淳实宏通，师之可也。若仅博雅能文，友之可也。或师或友，皆宜常存敬畏之心，不宜视为等夷，渐至慢亵，则不复能受其益矣</li>
<li>无论何书，总须从首至尾，通看一遍</li>
<li>先须看一家集，不要东翻两阅，先须学一体，不可各体同学，盖明一体，则皆明也</li>
<li>有困心衡虑郁积思通之象。此事断不可求速效</li>
<li>愈欲速则愈锢蔽矣，</li>
<li>绝大学问，即在家庭日用之间</li>
<li>无日不看书，虽万事业忙，亦不废正业。</li>
<li>日月逝矣，再过数年，则满三十，不能不趁三十以前，立志猛进也。</li>
<li>若自己不立志，则虽日与尧舜禹汤同住，亦彼自彼，我自我矣，何与于我哉</li>
<li>学问之道无穷，而总以有恒为主，</li>
<li>虽极忙，亦须了本日功课，不以昨日耽搁，而今日补做，不以明日有事，而今日预做。</li>
<li>切勿以家中有事，而间断看书之事，又勿以考试将近，而间断看书之课</li>
<li>若事事勤思善问，何患不一日千里</li>
<li>读书宜选一明师</li>
<li>一家之中，未能家长晏而子弟能早者也</li>
<li>家中读书事，弟宜常常留心，如甲五科三等，皆须读书，不失在家子弟风范，不可太疏忽也，</li>
<li>俭字工夫。日来稍有长进否？</li>
<li>用功，不求太猛，但求有恒</li>
<li>吾不望代代得富贵，但愿代代有秀才。</li>
<li>奋勉加功，为人与为学并进，切戒骄奢二字，则家中风气日厚</li>
<li>一曰看生书宜求速，不多读则太陋。一曰温旧书宜求熟，不背诵则易忘。一曰习字宜有恒，不善写则如身之无衣，山之无木。一曰作文宜苦思，不善作则如人之哑不能言，马之肢不能行。四者缺一不可，</li>
<li>和气蒸帮而家不兴者，未之有也</li>
<li>兄弟和，虽穷氓不户必兴，兄弟不和，虽世家宦族必败。</li>
<li>兄弟之情实以和睦兄弟为第一。</li>
<li>言忠信，行笃敬，虽蛮貊①之邦行矣。</li>
<li>只要有恒，不必贪多</li>
<li>澄弟亦须常看《五种遗规》及《呻吟语》，洗尽浮华，朴实谙练，上承祖父，下型子弟，吾于澄弟实有厚望焉</li>
<li>若非道义可得者，则不可轻易受此。要做好人，第一要在此处下手，能令鬼服神钦，则自然识日进，气日刚。否则不觉坠入卑污一流，必有被人看不起之日，不可不慎</li>
<li>受人恩情，当为将来报答之地，不可多求人也。</li>
<li>凡一家之中，勤敬二字，能守得几分，未有不兴，若全无一分，无有不败，和字能守得几分，未有不兴。不和未有不败者1123. 诸弟不好收拾洁净，比我尤甚，此是败家气明，嗣后务宜细心收拾，即一纸一缕，竹头木屑，皆宜检拾，以为儿侄之榜样，一代疏懒，二代淫佚，则必有昼睡夜坐，吸食鸦片之渐矣</li>
<li>子侄除读书外，教之扫屋抹桌凳，收粪锄草，是极好之事，切不可以为有损架子而不为也。</li>
<li>我有美名，则人必有受不美之名者，相形之际，盖难为情；兄惟谨慎谦虚，时时省惕①而已</li>
<li>勿使子侄骄奢淫佚</li>
<li>古人云：“劳则善心生，佚则淫心生。”孟子曰：“生于忧患，死于安乐。</li>
<li>一刻千金，切不可浪掷光</li>
<li>余在军中，不废学问，读书写字，未甚间断，惜年老眼蒙无甚长进，尔今未弱冠，一刻千金，切不可浪掷光阴</li>
<li>须以勤敏行之，每日至少亦须看二十页*。不必惑于在精不在多之说</li>
<li>纪泽看汉书，须以勤敏行之，每日至少亦须看二十页*。不必惑于在精不在多之说，须速点速读，不必一一求熟，恐因求熟之一字，而终身未能读完经书</li>
<li>靡不有初，鲜克有终</li>
<li>然祸福由天主之，善恶由人主之，由天主者，无可如何，只得听之。由人主者，尽得一分算一分，沙得一日算一日。吾兄弟断不可不洗心涤虑，以求力挽家运</li>
<li>第一贵兄弟和睦；第二贵体孝道；第三要实行勤俭二字</li>
<li>勤者，生动之气，俭者，收敛之气，有此二字，家运断无不兴之理。</li>
<li>“家庭不可说利害话，”此言精当之至，足抵万金</li>
<li>书蔬鱼猪，早扫考宝也！早者，起早也。扫者，扫屋也。考者，祖先祭祀；宝者，亲族邻里，时时周旋，贺喜吊丧，问疾济急。</li>
<li>照料家事，总以俭字为主，情意宜厚，用度宜俭，此居家乡之要诀也</li>
<li>总当以勤苦为体，谦逊为用，以药骄佚之积习</li>
<li>总怕子侄习于骄奢佚三字，家败离不得个奢字，人败离不得个佚字，讨人谦离不得个骄字。弟切戒之！总以谦勤二字为主，戒傲惰，</li>
<li>天地间惟谦谨是载福之道。骄则满，满则倾矣。凡动口动笔，厌人之俗，嫌人之鄙，议人之短，发人之覆①，皆骄也。无论所指未必果当，即使一一切当已为天道所不许</li>
<li>欲去骄字，总以不轻非笑人为第一义，欲去惰字，总以不晏起②为第一义</li>
<li>家中兄弟子侄，惟当记祖父这八个字，曰考宝早扫，书蔬鱼猪。又谨记祖父之三不信，曰不信地师，不信医药，不信僧巫。余日记册中，又有八本之说，曰读书以训诂为本，作诗文以声调为本，事亲以得欢心为本，养身以戒恼怒为本，立身以不妄语为本，居家以不晏起为本，作官以不要钱为本，行军以不扰民为本。此八本者，皆余阅历而确有把握之论，弟亦当教诸子侄谨记之。无论世之治乱，家之贫富，但能守星冈之公八字，与余之八本，总不失为上等人家。</li>
<li>俭以养廉，直而能忍</li>
<li>未有钱多而子弟不骄者也，吾兄弟欲为先人留遗泽，为后人惜余福，除去勤俭二字，别无做法</li>
<li>余教儿女辈，惟以勤俭谦三字为主。</li>
<li>盛名之下，其实难副，弟须慎之又慎</li>
<li>一则我家气运太盛，不可不格外小心，以为持盈保泰之道，旧债尽清，则好处太全，恐盈极生亏，留债不清，则好中不足，亦处乐之法</li>
<li>其舅之心，我弟以为可乎？兰姊蕙妹，家运皆</li>
<li>治军总须脚踏实地，克勤小物，乃可日起而有功，凡与人晋接①周旋，若无真意则不足以感人，然徒有真意，而无文饰以将之，则真意亦无所托之以出，礼所称“无文不行”也</li>
<li>书蔬猪鱼，考早扫宝，常设常行，八者都好，地命医理，僧巫祈祷，留客欠住，六者俱恼</li>
<li>凡事皆贵专，求师不专，则受益也不入，求友不专，则博爱而不亲，心有所专宗，而博观他涂以扩其只，亦无不可，无所专宗，而见异思迁，此眩彼夺①，则大不可</li>
<li>必须亲近良友，殷勤亲近，亲近愈久，获益愈多</li>
<li>交友须勤加来往</li>
<li>以后凡事不可占人半点便益，不可轻取人财，切记切记</li>
<li>贤弟从事多躁而少静，以后尚期三思</li>
<li>居官以耐烦为第一要义</li>
<li>此已露出不耐烦之端倪，将来恐不免于龃龉</li>
<li>余生平于朋友中，负人甚少，惟负次青实甚，两弟为我设法，有可挽回之处，余不惮改过也</li>
<li>进谏言戒除骄矜</li>
<li>吾惟以一勤字报吾君，以爱民二字书报吾亲，</li>
<li>凡有一长一技者，兄断不敢轻视</li>
<li>中庸学问思辨行五者，其要归于思必明，柔必强</li>
</ol>

                                                                        
                                    </div>
                                    <footer class="article-footer">
                                        <a data-url="http://jiaozhengkui.top/2018/01/31/曾国藩家书/" data-id="ckd90jonq009exc5169odwk02" class="article-share-link">
                                            Share
                                        </a>
                                        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/原创/">原创</a></li></ul>

                                    </footer>

    </div>

    

                

</article>
        
          <article id="post-iOS内核推荐博文" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

    <div class="article-inner">
        
            <header class="article-header">
                
  
    <h2 itemprop="name">
      <a class="article-title" href="/2018/01/23/iOS内核推荐博文/">iOS内核推荐博文</a>
    </h2>
  
  




            </header>
            

                
                    <div class="article-meta">
                        <a href="/2018/01/23/iOS内核推荐博文/" class="article-date">
  <time datetime="2018-01-23T10:14:18.000Z" itemprop="datePublished">2018-01-23</time>
</a>
                            
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

                    </div>
                    

                        

                                    <div class="article-entry" itemprop="articleBody">
                                        


                                            

                                                
                                                                    <h3 id="1-Mac-OS-X-和-iOS架构"><a href="#1-Mac-OS-X-和-iOS架构" class="headerlink" title="1 Mac OS X 和 iOS架构"></a>1 Mac OS X 和 iOS架构</h3><ol>
<li>用户体验层：主要有SpringBoard、Spotlight、Accessibility选项等等</li>
<li>应用框架层：主要有 Cocoa Touch、Java</li>
<li>核心框架层：主要有 OpenGL、Quartz等图形、多媒体组件</li>
<li>Darwin：操作系统核心，包括XNU内核(kernel)和UNIX shell</li>
</ol>
<h4 id="1-1-iOS-和-OS-X的不同点："><a href="#1-1-iOS-和-OS-X的不同点：" class="headerlink" title="1.1 iOS 和 OS X的不同点："></a>1.1 iOS 和 OS X的不同点：</h4><ul>
<li>iOS 内核和二进制文件编译的目标架构是ARM架构， OS X基于Intel i386 和 x86_64。</li>
<li>iOS 的内核闭源，OS X内核是开源的</li>
<li>iOS 的内存管理要紧凑的多。 iOS系统不支持虚拟内存，OS X通过内存映射获得额外的内存，几乎有无穷的交换空间可以使用。</li>
<li>iOS app不允许访问底层的Darwin，也没有root访问权限，并且只能访问自己目录内的数据。</li>
</ul>
<h3 id="2-Darwin架构"><a href="#2-Darwin架构" class="headerlink" title="2 Darwin架构"></a>2 Darwin架构</h3><p>&emsp;&emsp;盗图<a href="https://developer.apple.com/library/archive/documentation/Darwin/Conceptual/KernelProgramming/Architecture/Architecture.html#//apple_ref/doc/uid/TP30000905-CH1g-TPXREF101" target="_blank" rel="noopener">OS X Darwin</a>，iOS和OS X的Darwin架构差不多，我觉的这个更清晰易懂一些</p>
<p><img src="https://developer.apple.com/library/archive/documentation/Darwin/Conceptual/KernelProgramming/art/osxarchitecture.gif" alt="image"></p>
<p>&emsp;&emsp;Darwin的内核是XNU，XNU is Not Unix的缩写。XNU是由Mach微内核和BSD（伯克利软件套件）组合而成。</p>
<h4 id="2-1-Mach微内核"><a href="#2-1-Mach微内核" class="headerlink" title="2.1 Mach微内核"></a>2.1 Mach微内核</h4><p>&emsp;&emsp;Mach是一个微内核轻量级操作系统，仅处理最核心的任务，</p>
<ul>
<li>进程和线程</li>
<li>虚拟内存管理</li>
<li>任务调度</li>
<li>进程通信</li>
</ul>
<h4 id="2-2-BSD"><a href="#2-2-BSD" class="headerlink" title="2.2 BSD"></a>2.2 BSD</h4><p>&emsp;&emsp;BSD层在Mach之上，提供了更高层次的功能，包括：</p>
<ul>
<li>文件系统</li>
<li>网络（硬件设备级别除外）</li>
<li>UNIX安全模型</li>
<li>syscall 支持</li>
<li>BSD过程模型，包括过程ID和信号</li>
<li>FreeBSD内核API</li>
<li>许多POSIX API</li>
<li>内核支持pthreads（POSIX线程）</li>
</ul>
<h4 id="2-3-File-Systems"><a href="#2-3-File-Systems" class="headerlink" title="2.3 File Systems"></a>2.3 File Systems</h4><p>&emsp;&emsp;iOS 的文件系统和 OS X 非常类似，但是有以下区别：</p>
<ul>
<li>iOS文件系统（HFSX）是大小写敏感的, OS X 的 HFS+是不敏感</li>
<li>iOS文件系统是部分加密的。</li>
<li>没有/Users 目录，只有一个/User 目录</li>
<li>没有/Volumes目录, 没有必要进行磁盘仲裁</li>
</ul>
<h4 id="2-4-I-O-Kit"><a href="#2-4-I-O-Kit" class="headerlink" title="2.4 I/O Kit"></a>2.4 I/O Kit</h4><p>&emsp;&emsp;开发者可以使用C ++快速创建设备驱动程序。但内核是C语言或汇编写的，因此需要libKern库支持C ++运行时并提供所需要的基类。I/O Kit的功能：</p>
<ul>
<li>真正的即插即用</li>
<li>动态设备管理</li>
<li>动态（“按需”）加载驱动程序</li>
<li>桌面系统和便携式设备的电源管理</li>
<li>多处理器功能</li>
</ul>
<h3 id="3-系统调用"><a href="#3-系统调用" class="headerlink" title="3 系统调用"></a>3 系统调用</h3><h4 id="3-1-POSIX系统调用"><a href="#3-1-POSIX系统调用" class="headerlink" title="3.1 POSIX系统调用"></a>3.1 POSIX系统调用</h4><p>&emsp;&emsp;POSIX 兼容性是由XNU中BSD层提供的。所有的POSIX 系统调用不论底层实现如何都有相同的原型，也就是说具有相同的参数和返回值。<br>&emsp;&emsp;系统调用编号：除了固定的原型之外，POSIX还完整定义了系统调用的编号。</p>
<h4 id="3-2-Mach-系统调用"><a href="#3-2-Mach-系统调用" class="headerlink" title="3.2 Mach 系统调用"></a>3.2 Mach 系统调用</h4><p>&emsp;&emsp;BSD层是对Mach内核的包装，但是Mach系统调用仍然可以在用户态访问。需要借助mach trap实现用户态到内核态的转换。<br>&emsp;&emsp;在32位系统上，Mach系统调用的编号都为负数，POSIX调用编号为非负。<br>&emsp;&emsp;在64位系统上，Mach系统调用为正数，但是以0x2000000开头，而POSIX调用编号以0x1000000开头。</p>
<h3 id="博文推荐："><a href="#博文推荐：" class="headerlink" title="博文推荐："></a>博文推荐：</h3><p>&emsp;&emsp;最近在啃《深入解析Mac OS X &amp; iOS 操作系统》啃了一个多星期，我自以为我现在已经比上学的时候好多了，能看点书了！但还是啃不动了：太厚了造成我比较烦躁、没有试验机会、过时（市面上已经绝版了）！熬了一个多星期实在熬不住了！给大家推荐一个系列博客吧，博主应该是上学时啃的（估计工作也没时间）：<a href="https://www.jianshu.com/p/95acba84bfef" target="_blank" rel="noopener">https://www.jianshu.com/p/95acba84bfef</a></p>
<p>&emsp;&emsp;其实我觉得如果不考虑细微差别直接看OS X的官方文档反而是最舒服的 <a href="https://developer.apple.com/library/archive/documentation/Darwin/Conceptual/KernelProgramming/About/About.html#//apple_ref/doc/uid/TP30000905-CH204-TPXREF101" target="_blank" rel="noopener">https://developer.apple.com/library/archive/documentation/Darwin/Conceptual/KernelProgramming/About/About.html#//apple_ref/doc/uid/TP30000905-CH204-TPXREF101</a></p>

                                                                        
                                    </div>
                                    <footer class="article-footer">
                                        <a data-url="http://jiaozhengkui.top/2018/01/23/iOS内核推荐博文/" data-id="ckd90jolx004nxc51tglq5ar0" class="article-share-link">
                                            Share
                                        </a>
                                        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/原创/">原创</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/基础/">基础</a></li></ul>

                                    </footer>

    </div>

    

                

</article>
        
          <article id="post-你的灯亮着吗" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

    <div class="article-inner">
        
            <header class="article-header">
                
  
    <h2 itemprop="name">
      <a class="article-title" href="/2017/12/27/你的灯亮着吗/">你的灯亮着吗</a>
    </h2>
  
  




            </header>
            

                
                    <div class="article-meta">
                        <a href="/2017/12/27/你的灯亮着吗/" class="article-date">
  <time datetime="2017-12-27T10:14:18.000Z" itemprop="datePublished">2017-12-27</time>
</a>
                            
  <div class="article-category">
    <a class="article-category-link" href="/categories/读书/">读书</a>
  </div>

                    </div>
                    

                        

                                    <div class="article-entry" itemprop="articleBody">
                                        


                                            

                                                
                                                                    <ul>
<li>遇到问题不必着急去寻找解决办法，应该先明确问题</li>
<li>谁有问题：我们要取悦于谁，利益相关者！</li>
<li>要想的全面，针对每 种 利益相关者，问一下问题的本质是什么？</li>
<li>努力让别人接受观点，没有对错之分，不要反驳，不要争执，也不要放弃，最好诉诸于利益，告诉别人他的观点是可以代替的！</li>
<li>激化矛盾，或不着手处理问题，很可能会带来新的大问题，甚至忘记最开始的问题是什么！！！</li>
<li>问题其实就是你期望的东西和你体验的东西之间的差别。从这个角度看，要解决问题，要么改变期望，要么改变体验</li>
<li>对于那些没有幽默感的人，帮他们解决问题简直是自寻烦恼？</li>
<li>不要把他们的解决办法误认为是问题的定义–特别是你使用自己的解决方案时。</li>
<li>如果你太轻易的解决了他们的问题，他们永远都不会相信你真的解决了他们的问题。</li>
<li>关于真正解决问题的看法是：你永远不能肯定你已经某个问题有一个正确的定义，即使在这个问题已经解决之后。但永远不要放弃追寻正确定义的努力！</li>
<li>不要过早的下结论，但是也不要忽略你的第一印象。</li>
<li>如果问题是重要的，那么答案也一定是重要的吗？不！！！</li>
<li>每种解决问的办法都会带来新的问题。我们永远不可能消灭问题，只能不那么棘手了</li>
<li>问题最难以处理的部分恰恰是意识到它们的存在！</li>
<li>如果在对问题的理解中，你想不出至少3种可能出错的地方，那么你并没有真正的理解这个问题！</li>
<li>生活中有很多很不爽但你却自然去接受的地方！这就是对不相称的忽视，其实这里面有很多问题，都可以变得好一点和更好一点！很多东西都可以通过用一个从来没有见过它的“外国人”的观点来“看待”它！</li>
<li>每一种新的观点都会带来新的不相称，在实现这些“解决办法”前，最好多思考一下！</li>
<li>我们要怎样改变问题的表达方式才能获得不同的解决办法？</li>
<li>在特定层面上考虑问题。</li>
<li>当你在寻找问题的道路上疲倦的游荡时，不要忘记随时回头看看，看看你是不是迷路了</li>
<li>试着换过来指责自己–即使只有一秒钟</li>
<li>如果灯亮着，一个小小的提醒，可能比复杂的解决方案更有效！</li>
<li>问题的根源也许根本就不存在！</li>
<li></li>
</ul>

                                                                        
                                    </div>
                                    <footer class="article-footer">
                                        <a data-url="http://jiaozhengkui.top/2017/12/27/你的灯亮着吗/" data-id="ckd90jomh0066xc513swe8q6h" class="article-share-link">
                                            Share
                                        </a>
                                        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/原创/">原创</a></li></ul>

                                    </footer>

    </div>

    

                

</article>
        
          <article id="post-监听文件夹变化" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

    <div class="article-inner">
        
            <header class="article-header">
                
  
    <h2 itemprop="name">
      <a class="article-title" href="/2017/12/12/监听文件夹变化/">监听文件夹变化</a>
    </h2>
  
  




            </header>
            

                
                    <div class="article-meta">
                        <a href="/2017/12/12/监听文件夹变化/" class="article-date">
  <time datetime="2017-12-12T10:14:18.000Z" itemprop="datePublished">2017-12-12</time>
</a>
                            
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

                    </div>
                    

                        

                                    <div class="article-entry" itemprop="articleBody">
                                        


                                            

                                                
                                                                    <h3 id="1-timer-NSFileManager"><a href="#1-timer-NSFileManager" class="headerlink" title="1 timer+NSFileManager"></a>1 timer+NSFileManager</h3><p>&emsp;&emsp;这是我想到的第一个方案，方案很简单但效果非常不理想！轮询时间长了，可能会出现时间间隔内多次修改问题；轮询时间短了，太耗费性能，而且”短“的定义无法具象。具体代码不贴了</p>
<h3 id="2-GCD-source"><a href="#2-GCD-source" class="headerlink" title="2 GCD source"></a>2 GCD source</h3><p>&emsp;&emsp;必须得找一个让文件夹自己说话的方法，几经思索我想到了GCD，毕竟GCD可监控端口啥的，没准也可以监听文件夹！搜到一篇文章 <a href="http://ksnowlv.github.io/blog/2014/09/06/gcd-zhi-jian-ting-wen-jian/" target="_blank" rel="noopener">http://ksnowlv.github.io/blog/2014/09/06/gcd-zhi-jian-ting-wen-jian/</a> , 核心是创建读写权限的source通知！<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">NSArray *paths = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory,</span><br><span class="line">NSUserDomainMask, YES);</span><br><span class="line"></span><br><span class="line">if (paths.count == 0) &#123;</span><br><span class="line">return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NSString *ksnowDir =</span><br><span class="line">[[paths objectAtIndex:0] stringByAppendingPathComponent:@&quot;ksnow&quot;];</span><br><span class="line"></span><br><span class="line">NSLog(@&quot;ksnowdir = %@&quot;, ksnowDir);</span><br><span class="line"></span><br><span class="line">NSURL *directoryURL = [NSURL URLWithString:ksnowDir];</span><br><span class="line"></span><br><span class="line">int const fd =</span><br><span class="line">open([[directoryURL path] fileSystemRepresentation], O_EVTONLY);</span><br><span class="line">if (fd &lt; 0) &#123;</span><br><span class="line"></span><br><span class="line">NSLog(@&quot;Unable to open the path = %@&quot;, [directoryURL path]);</span><br><span class="line">return;</span><br><span class="line">&#125;</span><br><span class="line">dispatch_source_t source =</span><br><span class="line">dispatch_source_create(DISPATCH_SOURCE_TYPE_VNODE, fd,</span><br><span class="line">DISPATCH_VNODE_WRITE | DISPATCH_VNODE_RENAME,</span><br><span class="line">DISPATCH_TARGET_QUEUE_DEFAULT);</span><br><span class="line">dispatch_source_set_event_handler(source, ^() &#123;</span><br><span class="line">unsigned long const type = dispatch_source_get_data(source);</span><br><span class="line"></span><br><span class="line">switch (type) &#123;</span><br><span class="line">case DISPATCH_VNODE_WRITE: &#123;</span><br><span class="line">NSLog(@&quot;目录内容改变!!!&quot;);</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">case DISPATCH_VNODE_RENAME: &#123;</span><br><span class="line">NSLog(@&quot;目录被重命名!!!&quot;);</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">default:</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_source_set_cancel_handler(source, ^() &#123; close(fd); &#125;);</span><br><span class="line">self.source = source;</span><br><span class="line">dispatch_resume(self.source);</span><br></pre></td></tr></table></figure></p>
<h3 id="3-官方"><a href="#3-官方" class="headerlink" title="3 官方"></a>3 官方</h3><p>&emsp;&emsp;在检索的时候无意中发现官方已经给了dome ： <a href="https://developer.apple.com/library/content/samplecode/DocInteraction/Listings/Classes_DirectoryWatcher_m.html" target="_blank" rel="noopener">https://developer.apple.com/library/content/samplecode/DocInteraction/Listings/Classes_DirectoryWatcher_m.html</a> , 源码如下</p>
<p>&emsp;&emsp;核心思路是</p>
<ol>
<li>open打开文件夹，得到文件句柄。</li>
<li>创建kqueue队列来处理系统事件</li>
<li>创建kevent结构体，设置相关属性，并关联kqueue队列。</li>
<li>创建runloop source，设置回调函数并加到默认的runloopMode中。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (void)kqueueFired</span><br><span class="line">&#123;</span><br><span class="line">assert(kq &gt;= 0);</span><br><span class="line"></span><br><span class="line">struct kevent   event;</span><br><span class="line">struct timespec timeout = &#123;0, 0&#125;;</span><br><span class="line">int             eventCount;</span><br><span class="line"></span><br><span class="line">eventCount = kevent(kq, NULL, 0, &amp;event, 1, &amp;timeout);</span><br><span class="line">assert((eventCount &gt;= 0) &amp;&amp; (eventCount &lt; 2));</span><br><span class="line"></span><br><span class="line">// call our delegate of the directory change</span><br><span class="line">[delegate directoryDidChange:self];</span><br><span class="line"></span><br><span class="line">CFFileDescriptorEnableCallBacks(dirKQRef, kCFFileDescriptorReadCallBack);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void KQCallback(CFFileDescriptorRef kqRef, CFOptionFlags callBackTypes, void *info)</span><br><span class="line">&#123;</span><br><span class="line">DirectoryWatcher *obj;</span><br><span class="line"></span><br><span class="line">obj = (__bridge DirectoryWatcher *)info;</span><br><span class="line">assert([obj isKindOfClass:[DirectoryWatcher class]]);</span><br><span class="line">assert(kqRef == obj-&gt;dirKQRef);</span><br><span class="line">assert(callBackTypes == kCFFileDescriptorReadCallBack);</span><br><span class="line"></span><br><span class="line">[obj kqueueFired];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)startMonitoringDirectory:(NSString *)dirPath</span><br><span class="line">&#123;</span><br><span class="line">// Double initializing is not going to work...</span><br><span class="line">if ((dirKQRef == NULL) &amp;&amp; (dirFD == -1) &amp;&amp; (kq == -1))</span><br><span class="line">&#123;</span><br><span class="line">// Open the directory we&apos;re going to watch</span><br><span class="line">dirFD = open([dirPath fileSystemRepresentation], O_EVTONLY);</span><br><span class="line">if (dirFD &gt;= 0)</span><br><span class="line">&#123;</span><br><span class="line">// Create a kqueue for our event messages...</span><br><span class="line">kq = kqueue();</span><br><span class="line">if (kq &gt;= 0)</span><br><span class="line">&#123;</span><br><span class="line">struct kevent eventToAdd;</span><br><span class="line">eventToAdd.ident  = dirFD;</span><br><span class="line">eventToAdd.filter = EVFILT_VNODE;</span><br><span class="line">eventToAdd.flags  = EV_ADD | EV_CLEAR;</span><br><span class="line">eventToAdd.fflags = NOTE_WRITE;</span><br><span class="line">eventToAdd.data   = 0;</span><br><span class="line">eventToAdd.udata  = NULL;</span><br><span class="line"></span><br><span class="line">int errNum = kevent(kq, &amp;eventToAdd, 1, NULL, 0, NULL);</span><br><span class="line">if (errNum == 0)</span><br><span class="line">&#123;</span><br><span class="line">CFFileDescriptorContext context = &#123; 0, (__bridge void *)(self), NULL, NULL, NULL &#125;;</span><br><span class="line">CFRunLoopSourceRef      rls;</span><br><span class="line"></span><br><span class="line">// Passing true in the third argument so CFFileDescriptorInvalidate will close kq.</span><br><span class="line">dirKQRef = CFFileDescriptorCreate(NULL, kq, true, KQCallback, &amp;context);</span><br><span class="line">if (dirKQRef != NULL)</span><br><span class="line">&#123;</span><br><span class="line">rls = CFFileDescriptorCreateRunLoopSource(NULL, dirKQRef, 0);</span><br><span class="line">if (rls != NULL)</span><br><span class="line">&#123;</span><br><span class="line">CFRunLoopAddSource(CFRunLoopGetCurrent(), rls, kCFRunLoopDefaultMode);</span><br><span class="line">CFRelease(rls);</span><br><span class="line">CFFileDescriptorEnableCallBacks(dirKQRef, kCFFileDescriptorReadCallBack);</span><br><span class="line"></span><br><span class="line">// If everything worked, return early and bypass shutting things down</span><br><span class="line">return YES;</span><br><span class="line">&#125;</span><br><span class="line">// Couldn&apos;t create a runloop source, invalidate and release the CFFileDescriptorRef</span><br><span class="line">CFFileDescriptorInvalidate(dirKQRef);</span><br><span class="line">CFRelease(dirKQRef);</span><br><span class="line">dirKQRef = NULL;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">// kq is active, but something failed, close the handle...</span><br><span class="line">close(kq);</span><br><span class="line">kq = -1;</span><br><span class="line">&#125;</span><br><span class="line">// file handle is open, but something failed, close the handle...</span><br><span class="line">close(dirFD);</span><br><span class="line">dirFD = -1;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">return NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                                                                        
                                    </div>
                                    <footer class="article-footer">
                                        <a data-url="http://jiaozhengkui.top/2017/12/12/监听文件夹变化/" data-id="ckd90joo500ahxc5117uue3fo" class="article-share-link">
                                            Share
                                        </a>
                                        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/原创/">原创</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/基础/">基础</a></li></ul>

                                    </footer>

    </div>

    

                

</article>
        
          <article id="post-把时间当做朋友" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

    <div class="article-inner">
        
            <header class="article-header">
                
  
    <h2 itemprop="name">
      <a class="article-title" href="/2017/11/30/把时间当做朋友/">把时间当做朋友</a>
    </h2>
  
  




            </header>
            

                
                    <div class="article-meta">
                        <a href="/2017/11/30/把时间当做朋友/" class="article-date">
  <time datetime="2017-11-30T10:14:18.000Z" itemprop="datePublished">2017-11-30</time>
</a>
                            
  <div class="article-category">
    <a class="article-category-link" href="/categories/读书/">读书</a>
  </div>

                    </div>
                    

                        

                                    <div class="article-entry" itemprop="articleBody">
                                        


                                            

                                                
                                                                    <ul>
<li>时间是不可能被管理的。必须开启心智，看清楚，想明白：问题出在我们自己身上。而我们所面临的问题，与时间、管理或时间管理都没有多大的关系。解决方案只有一个，那就是“一切都靠积累”。深信积累的力量，时间就是你的朋友，否则它就是你的敌人。</li>
<li>不要再让自己成为自己大脑的奴隶，而是选择翻身做主人</li>
<li>管它呢，学呗，学了总有用处</li>
<li>告诉自己：我有不足，我需要时间，我没办法一蹴而就。就这样。</li>
<li>每个人的起点不同，有些人的地板是另外一些人的天花板。但起点就是起点，尽管不同，每个人都要从起点开始往前走。</li>
<li>拿出一张纸将其划分为左右两个部分，左边标题是“我有的”，右边标题是“我要的”。逐一罗列。而后尽量客观地判断，“我要的”那些有哪些是用“我有的”无法换取的—划掉。再仔细判断剩下的能用“我有的”换取的那些“我要的”之中究竟哪些是必须的、必要的、重要的、不可或缺的—加上重点标记，比如星号。</li>
<li>想到“我要什么”的时候，马上提醒自己要花上三倍的时间去想想“我有什么”。</li>
<li>做任何事情的时候，都需要时时刻刻忍受各种各样的不完美</li>
<li>为了进步，我们必须忍受一定的未知。</li>
<li>必须接受这个现实：未知永远存在。而后只能开始不断地尝试着去适应“在未知中不断前行”。</li>
<li>有问题解决不了时，暂时先把它记下来，而后继续前行。注意，一定要记下来</li>
<li>对现状不满，急于摆脱现状，往往是常人最常不知不觉就掉进去的陷阱</li>
<li>尽管现实总是如此难以接受，坚强的你却应该坦然</li>
<li>最好时常把自己的一些念头记录下来</li>
<li>不仅要接受，还要牢记；不仅要牢记，还要坚信，不容得半点动摇。</li>
<li>完成任何一个任务，往往都需要三倍于计划的时间—即便，从一开始就考虑到这个因素。</li>
<li>想要出类拔萃，就要努力至少一万小时。</li>
<li>开始越好”更好的答案是“现在就开始”。所谓做事拖拉，不是拖拖拉拉地做事，而是拖拖拉拉地就是不开始做正事。- 拖拉的人最本质的原因在于恐惧—无论是来自内部的（“不求有功，但求无过”），还是来自外部的（过分在意外界的评价）。</li>
<li>做事的时候，肯定会遇到困难，越是有价值的事情，困难越多越大。</li>
<li>没有人从一开始就能做对，没有人从一开始就能做好！只要做事，就一定会出问题。</li>
<li>简单的部分要迅速做完，而后把节约出来的时间投放在处理困难的部分上。</li>
<li>任务没有完整完成，所以，根本谈不上效率（相当于分子等于零）。</li>
<li>为了提高效率，我们必须把自己的大脑打造成一个“多任务操作系统，试着把一个复杂而又有机的任务与一个简单而又机械的任务搭配起来一起做。尽量并行两个任务，重要前提是：这两个任务之所以并行是因为你对自己了解所以才主动如此安排的</li>
<li>在做任何事情之前，通过关注HOW而反复拆分任务，最终确认每个子任务都是可完成的</li>
<li>“20分钟工作+5分钟休息”作为一个时间片，然后就开始像CPU一样处理任务</li>
<li>“没时间了”，其可怕程度几乎无异于死亡。也许有的时候，发现自己已经晚了，唯一的策略依然是“现在就开始”，否则更待何时？</li>
<li>很多的时候，“跟着感觉走”肯定是要吃亏的。</li>
<li>期望速成，从基本的层面上来看，有两个主要的原因。第一个是人希望自己的欲望马上得到满足的天性；另外一个期望速成的原因，也是浮躁的根源，是不懂得有些阶段就是无法跨越</li>
<li>无论对谁来讲，想进入自己的梦想职业都是成本高昂的</li>
<li>接受现状才是最优策略</li>
<li>不要常常觉得苦，而是要想办法在任何情况下找到情趣—快乐是一种本事</li>
<li>事情是否正确？看它是否现实。几乎一切愚蠢的行为都来自于否定现实逃避现实。</li>
<li>接受惩罚往往是积累经验的起点</li>
<li>很多人实际上根本不知道自己所谓的“喜欢做某件事情”实际上更可能只不过是因为那件事情相对简单、容易获得奖励而已</li>
<li>对于逃避困难的人来讲，最为关键的实际上不是WHAT，也不是WHY，而是HOW。</li>
<li>减少这种令人恼火的情况：被其他人的错误耽误自己的时间</li>
<li>先坐下来制定一个工作列表，把任务都罗列下来，而后把自己的时间切片。</li>
<li>基于过程的“事件-时间日志”记录可以调整我对时间的感觉，在估算任何工作量的时候，都更容易确定“真正现实可行的目标”。</li>
<li>既然“管理时间”是不可能的，那么解决方法就只能是：想尽一切办法真正了解自己，真正了解时间、精确地感知时间；而后再想尽一切办法使自己以及自己的行为与时间“合拍”，就是我的说法—“与时间做朋友”。</li>
<li>每天记录你的时间开销，每天都要制作你的时间预算。制作一个列表，把你今天需要做的事情罗列出来。给列表中的每项任务标上权重值—比如，你可以用1~5分进行标记</li>
<li>不要害怕修改。相信我，完成任何一项任务的过程中，修改都是不可或缺的内容。你在修改，就说明你在进步</li>
<li>判断每项任务的真实属性。然后选择“真的重要的”或者“显得不重要的”。“真的重要”，其实只需要一个标准：就是看这项任务的完成是否对你的目标达成确实有益</li>
<li>对像我这样的普通人来讲，证明我的目标现实可行的方法比较简单：1.已经有人做到了；2.我与那人没有太大的差距。</li>
<li>往往只有开始行动了之后，才可以做出正确的判断。在行动过程中，发现既定的目标确实是不现实的、不可行的，那么，半途而废不仅并不意味着失败，还意味着该决策者是无比理智的。</li>
<li>时间的浪费，往往是因为a.目标不现实或者目前暂时尚不可行；b.为了达到目标而制定的实施策略有误。</li>
<li>计划总是被变化打乱，更深层次的原因在于计划过于长远。</li>
<li>越是短期的目标，越容易清晰。越是清晰的目标越容易实现</li>
<li>乐观是靠努力和挣扎才可以获得的经验。</li>
<li>生活本身充满了意外，并且，总是意外到无以复加的地步。</li>
<li>做计划的时候，要知道这样一件事：做长期计划显然是正确的并且是必需的，但是，需要挣扎，需要努力，需要从一点一滴开始。不要一上来就开始制定过分长期的计划。</li>
<li>我知道那只不过是我的大脑的想法，而不应该是我的想法</li>
<li>没必要做计划的原因有两个：1.大多数计划其实非常简单”；2.“初始状态下，我们往往实际上并没有能力去制定合理有效的计划”。</li>
<li>大多数情况下，我的建议是这样的：如果你想改变你自己，或者你目前的处境并不令人满意，那就一切从简—找一个你觉得该给你带来改变的行动，然后去做就是了。不要怕碰壁，不要怕失败，那是必须经历的一个过程。还是那句话，失败并不可怕，因为你总是要失败许多次才会有结果，并且全天下又不是只有你一个人失败，怕什么？关键在于在每次挫折之后能否汲取教训。只要能汲取教训，然后自我调整，那就是进步了。</li>
<li>制作一个列表，往往会使自己做事井井有条，并保证自己不会没必要地浪费时间，列表没必要工整。关键在于要随时可以看到，随时可以书写和标记。真正最重要的任务永远只有一个—那个真正对你的目标实现有帮助的任务。真正紧急的事儿少之又少，除非万不得已，千万不要在整个任务完成之前中途更改列表中的项目。</li>
<li>有了什么新鲜主意，启用另外一个新的列表，标题是“下一阶段任务列表”，把你的新鲜主意记录在那里，然后马上回到当前的这个任务列表，专注在当前应该完成的任务上。</li>
<li>先判断你的这个列表所代表的那个任务是不是现实的，如果你真的觉得你能够、也应该完成这个任务，那就开始去做；并且一定要做到底。</li>
<li><p>我们所面临的大多数任务其实都是“重复性”的。只要遇到重复性任务，就要在做过一次之后，马上总结整理，将其流程梳理清楚，而后经过后来的实践把它变成“闭着眼睛也能做好”的事情。这是提高效率、减少失误的最根本手段。</p>
</li>
<li><p>为常见任务制定流程，是必须养成的习惯。在梳理流程的过程中，会不由自主地思考个中的细节，</p>
</li>
<li>在做任何事情之前，我都会尝试着把将要做的事情的整个过程在头脑中预演一遍甚至很多遍。执行的任务越重要，这种预演就越发不可或缺。学习的过程就是如此，它往往给你带来意想</li>
<li>遇到任何任务，都应该认真审视该任务，问自己一个问题并想办法回答清楚：“怎样才算做好？</li>
<li>学习是投资回报率最高的行为。</li>
<li>除了“试错”、“观察”、“阅读”之外，“思考”，准确地说，“正确地思考”，才是获取真正意义上的知识的主要手段。</li>
<li>每个人内心都充满了恐惧，所有的恐惧其实都源自于我们害怕未知。于是，恐惧是永恒的，因为我们永远不可能什么都知道。</li>
<li><p>知识传递过程中最大的障碍—“经验主义”</p>
</li>
<li><p>把那些目前暂时无法理解的、或者支持的、或者反对的，或者无所谓的论点观点记录下来。无法理解的，写下自己当时的疑惑究竟在什么地方；支持的，记录下几个自己的支持理由或者实例；反对的，也一样可以记录下几个自己的反对理由或者实例；甚至那些无所谓的，也可以写下为什么自己觉得这完全是无所谓的</p>
</li>
<li>在任何一个阶段，总是有一段时间进展缓慢，许久过后，所谓量变到质变的效果才会出现，才可能有突飞猛进的感觉</li>
<li>独立思考的钥匙之一是这样的：首先要了解：权威不一定等于正确。进一步要明白：就算权威正确，也只不过是权威表达了正确，而正确并不属于权威。最后要清楚：更准确地来说，权威只是权威、正确就是正确，它们俩什么时候都不是一回事儿。</li>
<li>接到任何任务之后，都勤于琢磨，去思考该任务的目标、实质、意义，而后再根据其目标、实质、意义去思考该任务的完成方法。于是，他们为了完成任务，实现目标，会去做很多领导原本甚至未曾想象过要交代的事情，最终，不仅完成任务，还常常有很多意外收获……</li>
<li>导致人们常常犯这些逻辑错误之中的最重要根源只有两个：概念不清和拒绝接受不确定性。</li>
<li>学习任何知识的时候，搞清楚所有它的基础概念是最重要的</li>
<li><p>“反过来不一定成立”这句话，值得牢记。</p>
</li>
<li><p>爱迪生是否是一个特别努力的人，本质上与我们没什么关系，我们该努力还得努力，不应该仅仅因为别人努力或者不努力，我们就放弃努力。</p>
</li>
<li>抱怨“上司的愚蠢”的人只有一个共同特征：他们只不过是把“上司很愚蠢”作为自己偷懒的借口而已</li>
<li>要么想办法帮助上司解决问题，要么就在爱莫能助的时候选择离开去自行其是。</li>
<li>人类拥有的普遍的认知偏差之一就是：把成功揽到自己身上，把失败归咎于别人或者坏运气。</li>
<li>努力从失败者身上汲取经验。有些时候，“成功者”的经验根本没有用，因为那些经验根本就是错误的。</li>
<li>人家说什么你就信什么，挺傻的。</li>
<li>强与弱才是自然界中真正存在的本质，善与恶更多的时候只不过是弱者一厢情愿的定义。</li>
<li>作为注定会老去死去的物种之一，人性中天生就充满了恐惧</li>
<li>过去的事情是无法更改的，现在的烦恼是无济于事的。但是，将来的尴尬也许是可以避免的—如果现在的行动没有出错的话</li>
<li>当脑子里闪出类似“要是……就好了！”的念头的时候，要马上提醒自己，“停！这个念头最耽误事儿了！”</li>
<li>人们只能听到自己想听到的，只能看到自己想看到的。</li>
<li>日积月累的过程中，要尽量有效甄别自己大脑中所存储的“已知信息”（大多是A类）的有效性。</li>
<li>为了真正做到有效倾听，最需要克制的就是“过早质疑”。就算需要质疑也一定要等到对方说完。</li>
<li>一旦决定倾听，就要主动帮助讲者进入“倾诉”状态。</li>
<li>为了避免在讨论的过程中出现不必要的麻烦，浪费不必要的时间[75]，我们必须深刻理解以下三个原则。</li>
<li>A，有意义之讨论的前提是双方不仅要“相互竞争”更重要的是还要“相互合作”。如果你在任何讨论中发现参与者里面有“自以为是”者存在，你其实只有一个选择，退出讨论</li>
<li>B：事实、真相、真理、道理（即所谓的“Truth”；下文中全部使用“Truth”这个英文单词指代）是独立存在的，从来不会依附于任何个人或者集体存在。</li>
<li>C：Truth不变，也不会因任何人而变；不停变化的只是人们对Truth的解释或者理解</li>
<li>避免自以为是地认为自己肯定理解对了，不妨套用以下这个句式，进行验证、反馈：“你的意思是……，是么？” 　　或者 　　“你的意思是……，你看我理解的对么？”</li>
<li>摆脱经验主义的局限，不仅需要对道理本身的了解，最终还需要勇气</li>
<li>深刻了解了经验之局限之后，所需要做的就是时时刻刻保持警惕</li>
<li>观察与阅读是扩充有限的自我经验的最好手段。</li>
<li>绝大多数人仅因为自己的态度而失去积累、成长的可能</li>
<li>类比思考几乎是跨越已知与未知之间的鸿沟的唯一手段。</li>
<li>一定要问清楚自己这个问题：我不喜欢做这件事情有没有可能仅仅是因为这件事儿我并没有做好？做好这件事情究竟对自己有没有意义？</li>
<li>并不是对正在做的事情没有兴趣，而是没能力把目前正在做的事情做好，最终没有人喜欢自己做不好的事情。</li>
<li>往往并不是有兴趣才能做好，而是做好了才有兴趣。</li>
<li>成功，都只靠两件事：策略和坚持，而坚持本身就是最重要的策略<br>方法固然重要，但是比起“用功”来说，方法几乎可以忽略不计。说</li>
<li>所谓的“好的方法”实际上是因人而异的。适合这个人的方法放到另外一个人身上很可能适得其反，适合所有人的方法可能根本不存在。与其不停地找更好的方法，还不如马上开始行动，省得虚度更多的时间。</li>
<li>自己所面临的痛苦并没有所感受到的那么强烈，第一种办法是当你面临尴尬的时候，记得一定要拿出纸笔来，把你所遇到的尴尬记录下来；另一个办法是，在面临尴尬的时候，尽量弱化你的痛苦。</li>
<li>尽管情绪有很多种，但最需要控制的大抵上只有一种：痛苦</li>
<li>很多的时候，比较是个坑，大坑。再干脆点，比较就是陷阱<br>比成功更重要的是成长。</li>
<li>一定要想清楚并记住这件事儿：相信运气其实是缺乏自制力的表现。</li>
<li>浪费时间、虚度年华的人，有个共同的特征—他们拼命想控制自己完全不能控制的，却在自己真正能掌控的地方彻底失控。</li>
<li>弱者相信运气，强者只究因果</li>
<li>努力往往真的会改变一个人的运气</li>
<li>千万不要相信“机不可失，时不再来”。当你没有准备好的时候，对你来讲，不存在任何机会。</li>
<li>承认自己能力有限，是心理健康的前提</li>
<li>“量力而行”是如此高难度的行为模式—a.承认自己能力有限；b.不怕在别人面前露怯；c.敢于不去证明自己是“好人”</li>
<li>生活的智慧就在于，集中精力改变那些能够改变的，而把那些不能改变的暂时忽略掉。专心打造自己，把自己打造成一个优秀的人，一个有用的人，一个独立的人，比什么都重要。打造自己，就等于打造人脉，因为只有优秀的人才拥有有效的人脉。</li>
<li>专心做可以提升自己的事情，学习并拥有更多更好的技能，成为一个值得交往的人。</li>
<li>停止嘲弄他人，己所不欲，勿施于人”</li>
<li>素材积累固然非常重要，然而，如果提前确定一个方向或者目标，那么就甚至可以积累很多原本不可能想象的素材—惊喜连连。</li>
<li>永远鼓励身边的人，哪怕多少有些盲目。</li>
<li>当你不停地鼓励所有人的时候，最大的受益者其实是你自己，因为最终你会发现你开始进入一种他人无法想象的状态：你成了一个不需要他人鼓励的人。</li>
<li>记住，你不可能百分之百地有效率，至少不可能总是百分之百地有效率</li>
<li>在做时间预算的时候，一定要留有空间。a.你必须清楚肯定会有意外事件发生，b.你必须用适当的方法休息、放松</li>
<li>“累”这个事实，造成一种幻觉“我一直在努力”。</li>
<li>凡是值得做的事情，都值得慢慢做—做很久很久。</li>
<li>要想办法提前预知自己需要怎样的技能，然后确定那是一个自己可以通过练习真正熟练掌握的技能，而后制定长期计划，一点一点地执行该计划</li>
<li>不要盲目地试图减少睡眠时间。</li>
<li>尽量不要减少与家庭成员和亲属交流的时间。</li>
<li>最好不要放弃你的社交时间</li>
<li>“证明自己给别人看”恰恰是最浪费生命的一种行为。</li>
<li>任何积累都需要时间，并且必然需要漫长的时间。</li>
<li>“出来混的，早晚要还”</li>
</ul>

                                                                        
                                    </div>
                                    <footer class="article-footer">
                                        <a data-url="http://jiaozhengkui.top/2017/11/30/把时间当做朋友/" data-id="ckd90jonn0095xc51zdszlae6" class="article-share-link">
                                            Share
                                        </a>
                                        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/原创/">原创</a></li></ul>

                                    </footer>

    </div>

    

                

</article>
        
          <article id="post-函数式编程和链式编程" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

    <div class="article-inner">
        
            <header class="article-header">
                
  
    <h2 itemprop="name">
      <a class="article-title" href="/2017/11/12/函数式编程和链式编程/">函数式编程和链式编程</a>
    </h2>
  
  




            </header>
            

                
                    <div class="article-meta">
                        <a href="/2017/11/12/函数式编程和链式编程/" class="article-date">
  <time datetime="2017-11-12T10:14:18.000Z" itemprop="datePublished">2017-11-12</time>
</a>
                            
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

                    </div>
                    

                        

                                    <div class="article-entry" itemprop="articleBody">
                                        


                                            

                                                
                                                                    <p>&emsp;&emsp;简单说下函数式编程和链式编程的理解</p>
<h3 id="函数式编程"><a href="#函数式编程" class="headerlink" title="函数式编程"></a>函数式编程</h3><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p>&emsp;&emsp;函数式编程所强调的函数，上述两点可翻译为：1、不依赖外部状态；2、不改变外部状态</p>
<ul>
<li>理想状态下的纯函数</li>
<li>变量作用域在函数内，如果需要外部变量需要当做函数的参数传入</li>
<li>不会产生副作用，不能改变被转入数据或其他数据</li>
<li>相同入参，返回值必然相同 </li>
<li>函数作为一等公民，跟swift一样理解即可</li>
<li>高阶函数：可以把函数作为参数传递给另一个函数</li>
<li>优化技术：尾调用优化技术，即最后一个return返回一个函数，减少压栈次数，参考：<a href="http://www.ruanyifeng.com/blog/2015/04/tail-call.html" target="_blank" rel="noopener">尾调用优化</a></li>
</ul>
<h4 id="OC实现，代表RAC"><a href="#OC实现，代表RAC" class="headerlink" title="OC实现，代表RAC"></a>OC实现，代表RAC</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@interface Person : NSObject</span><br><span class="line">- (Person *)walk:(NSString * (^)(void))hotel;</span><br><span class="line">- (Person *)eat:(NSString * (^)(NSArray *))food;</span><br><span class="line">- (Person *)sayGood;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation Person</span><br><span class="line">- (Person *)walk:(NSString * (^)(void))hotel &#123;</span><br><span class="line">NSLog(@&quot;go to %@&quot;,hotel());</span><br><span class="line">return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (Person *)eat:(NSString * (^)(NSArray *))food &#123;</span><br><span class="line">NSString *someFood = food(@[@&quot;apple&quot;,@&quot;banner&quot;,@&quot;potato&quot;]);</span><br><span class="line">NSLog(@&quot;eat %@&quot;,someFood);</span><br><span class="line">return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (Person *)sayGood &#123;</span><br><span class="line">NSLog(@&quot;the food is vear good!&quot;);</span><br><span class="line">return self;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">// 使用</span><br><span class="line">Person *person = [[Person alloc] init];</span><br><span class="line">[[[person walk:^NSString * _Nonnull&#123;</span><br><span class="line">return @&quot;my home&quot;;</span><br><span class="line">&#125;] eat:^NSString * _Nonnull(NSArray * _Nonnull foods) &#123;</span><br><span class="line">return foods[1];</span><br><span class="line">&#125;] sayGood ];</span><br></pre></td></tr></table></figure>
<h3 id="链式编程"><a href="#链式编程" class="headerlink" title="链式编程"></a>链式编程</h3><p>&emsp;&emsp;多个方法使用点语法链接起来，让代码更加简洁，可读性更强</p>
<h4 id="OC实现，代表Masonry"><a href="#OC实现，代表Masonry" class="headerlink" title="OC实现，代表Masonry"></a>OC实现，代表Masonry</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">@class Person;</span><br><span class="line">typedef Person *_Nonnull(^actionBlock)(NSString *);</span><br><span class="line">@interface Person : NSObject</span><br><span class="line">@property (nonatomic, strong) NSMutableString *log;</span><br><span class="line">@property (nonatomic, copy) actionBlock walk;</span><br><span class="line">@property (nonatomic, copy) actionBlock eat;</span><br><span class="line">@property (nonatomic, copy) actionBlock sayGood;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation Person</span><br><span class="line">- (instancetype)init &#123;</span><br><span class="line">self = [super init];</span><br><span class="line">if (self) &#123;</span><br><span class="line">_log = [[NSMutableString alloc] init];</span><br><span class="line">&#125;</span><br><span class="line">return self;</span><br><span class="line">&#125;</span><br><span class="line">- (actionBlock)walk &#123;</span><br><span class="line">__block NSMutableString *log = _log;</span><br><span class="line">return ^(NSString *str)&#123;</span><br><span class="line">[log appendString:[NSString stringWithFormat:@&quot;go to %@&quot;,str]];</span><br><span class="line">return self;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line">- (actionBlock)eat &#123;</span><br><span class="line">__block NSMutableString *log = _log;</span><br><span class="line">return ^(NSString *str)&#123;</span><br><span class="line">[log appendString:[NSString stringWithFormat:@&quot; eat %@&quot;,str]];</span><br><span class="line">return self;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line">- (actionBlock)sayGood &#123;</span><br><span class="line">__block NSMutableString *log = _log;</span><br><span class="line">return ^(NSString *str)&#123;</span><br><span class="line">[log appendString:[NSString stringWithFormat:@&quot; the %@ is vear good!&quot;,str]];</span><br><span class="line">return self;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">Person *p = [[Person alloc] init];</span><br><span class="line">p.walk(@&quot;my home&quot;).eat(@&quot;apple&quot;).sayGood(@&quot;apple&quot;);</span><br><span class="line">NSLog(@&quot;%@&quot;,p.log);</span><br></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://www.cnblogs.com/zy1987/p/3788670.html" target="_blank" rel="noopener">https://www.cnblogs.com/zy1987/p/3788670.html</a></li>
<li><a href="http://mrpeak.cn/blog/functional/" target="_blank" rel="noopener">http://mrpeak.cn/blog/functional/</a></li>
<li><a href="https://blog.csdn.net/sinat_27706697/article/details/48946485" target="_blank" rel="noopener">https://blog.csdn.net/sinat_27706697/article/details/48946485</a></li>
</ul>
<h4 id="更新参考"><a href="#更新参考" class="headerlink" title="更新参考"></a>更新参考</h4><ul>
<li><a href="https://mp.weixin.qq.com/s/0gErQ3tjDLZuD1bYOhi0mQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/0gErQ3tjDLZuD1bYOhi0mQ</a></li>
<li><a href="https://www.liaoxuefeng.com/article/1260118907809920" target="_blank" rel="noopener">https://www.liaoxuefeng.com/article/1260118907809920</a></li>
<li></li>
</ul>

                                                                        
                                    </div>
                                    <footer class="article-footer">
                                        <a data-url="http://jiaozhengkui.top/2017/11/12/函数式编程和链式编程/" data-id="ckd90jomm006lxc514yq5nuhr" class="article-share-link">
                                            Share
                                        </a>
                                        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/原创/">原创</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/基础/">基础</a></li></ul>

                                    </footer>

    </div>

    

                

</article>
        
          <article id="post-xib与代码颜色偏差问题" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

    <div class="article-inner">
        
            <header class="article-header">
                
  
    <h2 itemprop="name">
      <a class="article-title" href="/2017/10/20/xib与代码颜色偏差问题/">xib与代码颜色偏差问题</a>
    </h2>
  
  




            </header>
            

                
                    <div class="article-meta">
                        <a href="/2017/10/20/xib与代码颜色偏差问题/" class="article-date">
  <time datetime="2017-10-20T10:14:18.000Z" itemprop="datePublished">2017-10-20</time>
</a>
                            
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

                    </div>
                    

                        

                                    <div class="article-entry" itemprop="articleBody">
                                        


                                            

                                                
                                                                    <p>&emsp;&emsp;今天视觉走查时发现一个问题，视觉给的stech文件给出了颜色值，正常流程是拿到颜色值直接扔过去就不管了！但今天踩雷了，UI的火眼金睛竟然发下颜色不一样，代码里数值明明都是一样的，但仔细观察的话，确实有一点点的区别。这是为什么？</p>
<p>&emsp;&emsp;经过仔细排查，没发现任何程序上的问题，且发现纯代码设置的颜色是正确的，只有xib/SB设置的颜色不正确，那是不是xib自己的坑？</p>
<p>&emsp;&emsp;新建一个xib，随便选个颜色，保存，右键查看xml，得到源码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;view contentMode=&quot;scaleToFill&quot; id=&quot;iN0-l3-epB&quot;&gt;</span><br><span class="line">&lt;rect key=&quot;frame&quot; x=&quot;0.0&quot; y=&quot;0.0&quot; width=&quot;414&quot; height=&quot;896&quot;/&gt;</span><br><span class="line">&lt;autoresizingMask key=&quot;autoresizingMask&quot; widthSizable=&quot;YES&quot; heightSizable=&quot;YES&quot;/&gt;</span><br><span class="line">&lt;color key=&quot;backgroundColor&quot; red=&quot;0.0&quot; green=&quot;0.97680455450000003&quot; blue=&quot;0.0&quot; alpha=&quot;1&quot; colorSpace=&quot;custom&quot; customColorSpace=&quot;sRGB&quot;/&gt;</span><br><span class="line">&lt;/view&gt;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;代码设置颜色的方法如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UIColor *colorFromRGB(float r, float g, float b, float alpha) &#123;</span><br><span class="line">return [UIColor colorWithRed:r/255.f green:g/255.f blue:b/255.f alpha:alpha];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;对比发现xib多了一个colorSpace，即颜色空间！很有可能是这个问题，再次查阅官方文档，发现如下解释<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ (UIColor *)colorWithRed:(CGFloat)red green:(CGFloat)green blue:(CGFloat)blue alpha:(CGFloat)alpha;</span><br><span class="line"></span><br><span class="line">The color object. The color information represented by this object is in an RGB colorspace. On applications linked for iOS 10 or later, the color is specified in an extended range sRGB color space. On earlier versions of iOS, the color is specified in a device RGB colorspace.</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;简单翻译就是iOS10之后使用sRGB颜色空间，iOS10之前跟随系统颜色空间设置</p>
<p>&emsp;&emsp;那iOS10之前的颜色空间是什么？查阅到<a href="https://medium.com/@ethanhuang13/ios-interface-builder指定顏色與實際有出入-19735b3f467b" target="_blank" rel="noopener">.Xcode Interface Builder 指定顏色與實際有出入  </a></p>
<ul>
<li>Xib/Storyboard默认用的是sRGB。</li>
<li>Sketch用的是sRGB。</li>
<li>PhotoShop默认用的是Generic RGB。</li>
<li>代码中的UIColor赋值，用的是Generic RGB。</li>
</ul>
<p>&emsp;&emsp;很明显了！修改方式也比较简单了，把颜色空间改成sRGB即可</p>
<p>&emsp;&emsp;本来到这为止！我已经水完了！已经完成了水一篇的任务！</p>
<p>&emsp;&emsp;但是我们的 .clr文件里有一百多个颜色值，我怎么改才行？</p>
<ul>
<li>最理想：写算法批量转化！但我不懂颜色空间的知识，而且这个是一次性操作，专门去学习成本太高！<strong>失败</strong></li>
<li>退而次之：直接在xib里修改颜色值的colorspace！不行，因为xib里直接修改颜色值，xcode为了保证颜色一致，修改了Red，Green和Blue的值，而我们的需求是Red，Green和Blue的值是正确的</li>
<li>再次之：手动输入Red，Green和Blue的值，再选择colorspace！可以做，但工作量比较大，而且步骤较多，以后新增颜色出问题的可能性比较大！.clr文件是共享的，维护成本较高</li>
</ul>
<p>&emsp;&emsp;经过数次试验发现：在xib里使用吸管来取颜色值，能够正确的取到了Red，Green和Blue的值，并正确设置colorspace！</p>
<p>&emsp;&emsp;==结论：使用吸管来吸颜色最靠谱，团队维护成本也较低==</p>

                                                                        
                                    </div>
                                    <footer class="article-footer">
                                        <a data-url="http://jiaozhengkui.top/2017/10/20/xib与代码颜色偏差问题/" data-id="ckd90jome005uxc51cxzmjezv" class="article-share-link">
                                            Share
                                        </a>
                                        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/UI/">UI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/原创/">原创</a></li></ul>

                                    </footer>

    </div>

    

                

</article>
        
          <article id="post-Masonry都干了什么" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

    <div class="article-inner">
        
            <header class="article-header">
                
  
    <h2 itemprop="name">
      <a class="article-title" href="/2017/10/12/Masonry都干了什么/">Masonry都干了什么？</a>
    </h2>
  
  




            </header>
            

                
                    <div class="article-meta">
                        <a href="/2017/10/12/Masonry都干了什么/" class="article-date">
  <time datetime="2017-10-11T16:31:35.000Z" itemprop="datePublished">2017-10-12</time>
</a>
                            
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

                    </div>
                    

                        

                                    <div class="article-entry" itemprop="articleBody">
                                        


                                            

                                                
                                                                    <ol>
<li><p>不需要weak strong因为没引用self</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (NSArray *)mas_makeConstraints:(void(^)(MASConstraintMaker *))block &#123;</span><br><span class="line">    self.translatesAutoresizingMaskIntoConstraints = NO;</span><br><span class="line">    MASConstraintMaker *constraintMaker = [[MASConstraintMaker alloc] initWithView:self];</span><br><span class="line">    block(constraintMaker);</span><br><span class="line">    return [constraintMaker install];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>make.left.equalTo(@0).offset(1);的解读：.left直接返回self，equalTo是一个block，调用的时候需要也一个参数@0，block返回self。这样又可以调offset</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@interface MASConstraint : NSObject</span><br><span class="line"></span><br><span class="line">- (MASConstraint *)left &#123;</span><br><span class="line">    return [self addConstraintWithLayoutAttribute:NSLayoutAttributeLeft];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// </span><br><span class="line">- (MASConstraint * (^)(id attr))equalTo;</span><br><span class="line">- (MASConstraint * (^)(id))equalTo &#123;</span><br><span class="line">    return ^id(id attribute) &#123;</span><br><span class="line">        return self.equalToWithRelation(attribute, NSLayoutRelationEqual);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (MASConstraint * (^)(CGFloat offset))offset;</span><br><span class="line">- (MASConstraint * (^)(CGFloat))offset &#123;</span><br><span class="line">    return ^id(CGFloat offset)&#123;</span><br><span class="line">        self.offset = offset;</span><br><span class="line">        return self;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>.left 只是将约束放到了self.constraints</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (MASConstraint *)constraint:(MASConstraint *)constraint addConstraintWithLayoutAttribute:(NSLayoutAttribute)layoutAttribute &#123;</span><br><span class="line">    MASViewAttribute *viewAttribute = [[MASViewAttribute alloc] initWithView:self.view layoutAttribute:layoutAttribute];</span><br><span class="line">    MASViewConstraint *newConstraint = [[MASViewConstraint alloc] initWithFirstViewAttribute:viewAttribute];</span><br><span class="line">    if ([constraint isKindOfClass:MASViewConstraint.class]) &#123;</span><br><span class="line">        //replace with composite constraint</span><br><span class="line">        NSArray *children = @[constraint, newConstraint];</span><br><span class="line">        MASCompositeConstraint *compositeConstraint = [[MASCompositeConstraint alloc] initWithChildren:children];</span><br><span class="line">        compositeConstraint.delegate = self;</span><br><span class="line">        [self constraint:constraint shouldBeReplacedWithConstraint:compositeConstraint];</span><br><span class="line">        return compositeConstraint;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!constraint) &#123;</span><br><span class="line">        newConstraint.delegate = self;</span><br><span class="line">        [self.constraints addObject:newConstraint];</span><br><span class="line">    &#125;</span><br><span class="line">    return newConstraint;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>equalTo 实际调用的是MASConstraint的equalToWithRelation方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (MASConstraint * (^)(id))equalTo &#123;</span><br><span class="line">    return ^id(id attribute) &#123;</span><br><span class="line">        return self.equalToWithRelation(attribute, NSLayoutRelationEqual);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (MASConstraint * (^)(id, NSLayoutRelation))equalToWithRelation &#123;</span><br><span class="line">    return ^id(id attribute, NSLayoutRelation relation) &#123;</span><br><span class="line">        if ([attribute isKindOfClass:NSArray.class]) &#123;</span><br><span class="line">            NSAssert(!self.hasLayoutRelation, @&quot;Redefinition of constraint relation&quot;);</span><br><span class="line">            NSMutableArray *children = NSMutableArray.new;</span><br><span class="line">            for (id attr in attribute) &#123;</span><br><span class="line">                MASViewConstraint *viewConstraint = [self copy];</span><br><span class="line">                viewConstraint.layoutRelation = relation;</span><br><span class="line">                viewConstraint.secondViewAttribute = attr;</span><br><span class="line">                [children addObject:viewConstraint];</span><br><span class="line">            &#125;</span><br><span class="line">            MASCompositeConstraint *compositeConstraint = [[MASCompositeConstraint alloc] initWithChildren:children];</span><br><span class="line">            compositeConstraint.delegate = self.delegate;</span><br><span class="line">            [self.delegate constraint:self shouldBeReplacedWithConstraint:compositeConstraint];</span><br><span class="line">            return compositeConstraint;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            NSAssert(!self.hasLayoutRelation || self.layoutRelation == relation &amp;&amp; [attribute isKindOfClass:NSValue.class], @&quot;Redefinition of constraint relation&quot;);</span><br><span class="line">            self.layoutRelation = relation;</span><br><span class="line">            self.secondViewAttribute = attribute;</span><br><span class="line">            return self;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>offset要干的就是保存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (MASConstraint * (^)(CGFloat))offset &#123;</span><br><span class="line">    return ^id(CGFloat offset)&#123;</span><br><span class="line">        self.offset = offset;</span><br><span class="line">        return self;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下来最主要的方法install,实际调用的是MASViewConstraint的install</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (NSArray *)install &#123;</span><br><span class="line">    // update或remove需要用到</span><br><span class="line">    if (self.removeExisting) &#123;</span><br><span class="line">        NSArray *installedConstraints = [MASViewConstraint installedConstraintsForView:self.view];</span><br><span class="line">        for (MASConstraint *constraint in installedConstraints) &#123;</span><br><span class="line">            [constraint uninstall];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    NSArray *constraints = self.constraints.copy;</span><br><span class="line">    for (MASConstraint *constraint in constraints) &#123;</span><br><span class="line">        constraint.updateExisting = self.updateExisting;</span><br><span class="line">        [constraint install];</span><br><span class="line">    &#125;</span><br><span class="line">    [self.constraints removeAllObjects];</span><br><span class="line">    return constraints;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>MASViewConstraint的install来设置系统约束</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">- (void)install &#123;</span><br><span class="line">    if (self.hasBeenInstalled) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 设置left时设置了firstViewAttribute</span><br><span class="line">    if ([self supportsActiveProperty] &amp;&amp; self.layoutConstraint) &#123;</span><br><span class="line">        self.layoutConstraint.active = YES;</span><br><span class="line">        [self.firstViewAttribute.view.mas_installedConstraints addObject:self];</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // equalto时设置了secondViewAttribute</span><br><span class="line">    MAS_VIEW *firstLayoutItem = self.firstViewAttribute.item;</span><br><span class="line">    NSLayoutAttribute firstLayoutAttribute = self.firstViewAttribute.layoutAttribute;</span><br><span class="line">    MAS_VIEW *secondLayoutItem = self.secondViewAttribute.item;</span><br><span class="line">    NSLayoutAttribute secondLayoutAttribute = self.secondViewAttribute.layoutAttribute;</span><br><span class="line"></span><br><span class="line">    // alignment attributes must have a secondViewAttribute</span><br><span class="line">    // therefore we assume that is refering to superview</span><br><span class="line">    // eg make.left.equalTo(@10)</span><br><span class="line">    if (!self.firstViewAttribute.isSizeAttribute &amp;&amp; !self.secondViewAttribute) &#123;</span><br><span class="line">        secondLayoutItem = self.firstViewAttribute.view.superview;</span><br><span class="line">        secondLayoutAttribute = firstLayoutAttribute;</span><br><span class="line">    &#125;</span><br><span class="line">    // self.layoutConstant 就是offset(1)</span><br><span class="line">    MASLayoutConstraint *layoutConstraint</span><br><span class="line">        = [MASLayoutConstraint constraintWithItem:firstLayoutItem</span><br><span class="line">                                        attribute:firstLayoutAttribute</span><br><span class="line">                                        relatedBy:self.layoutRelation</span><br><span class="line">                                           toItem:secondLayoutItem</span><br><span class="line">                                        attribute:secondLayoutAttribute</span><br><span class="line">                                       multiplier:self.layoutMultiplier</span><br><span class="line">                                         constant:self.layoutConstant];</span><br><span class="line">    </span><br><span class="line">    layoutConstraint.priority = self.layoutPriority;</span><br><span class="line">    layoutConstraint.mas_key = self.mas_key;</span><br><span class="line">    </span><br><span class="line">    if (self.secondViewAttribute.view) &#123;</span><br><span class="line">        MAS_VIEW *closestCommonSuperview = [self.firstViewAttribute.view mas_closestCommonSuperview:self.secondViewAttribute.view];</span><br><span class="line">        NSAssert(closestCommonSuperview,</span><br><span class="line">                 @&quot;couldn&apos;t find a common superview for %@ and %@&quot;,</span><br><span class="line">                 self.firstViewAttribute.view, self.secondViewAttribute.view);</span><br><span class="line">        self.installedView = closestCommonSuperview;</span><br><span class="line">    &#125; else if (self.firstViewAttribute.isSizeAttribute) &#123;</span><br><span class="line">        self.installedView = self.firstViewAttribute.view;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        self.installedView = self.firstViewAttribute.view.superview;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    MASLayoutConstraint *existingConstraint = nil;</span><br><span class="line">    if (self.updateExisting) &#123;</span><br><span class="line">        existingConstraint = [self layoutConstraintSimilarTo:layoutConstraint];</span><br><span class="line">    &#125;</span><br><span class="line">    if (existingConstraint) &#123;</span><br><span class="line">        // just update the constant</span><br><span class="line">        existingConstraint.constant = layoutConstraint.constant;</span><br><span class="line">        self.layoutConstraint = existingConstraint;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        [self.installedView addConstraint:layoutConstraint];</span><br><span class="line">        self.layoutConstraint = layoutConstraint;</span><br><span class="line">        [firstLayoutItem.mas_installedConstraints addObject:self];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ol>

                                                                        
                                    </div>
                                    <footer class="article-footer">
                                        <a data-url="http://jiaozhengkui.top/2017/10/12/Masonry都干了什么/" data-id="ckd90joku0027xc51lbfjfc7y" class="article-share-link">
                                            Share
                                        </a>
                                        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/原创/">原创</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/原理/">原理</a></li></ul>

                                    </footer>

    </div>

    

                

</article>
        
          <article id="post-FishHook都干了什么" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

    <div class="article-inner">
        
            <header class="article-header">
                
  
    <h2 itemprop="name">
      <a class="article-title" href="/2017/10/10/FishHook都干了什么/">FishHook都干了什么？</a>
    </h2>
  
  




            </header>
            

                
                    <div class="article-meta">
                        <a href="/2017/10/10/FishHook都干了什么/" class="article-date">
  <time datetime="2017-10-09T16:31:35.000Z" itemprop="datePublished">2017-10-10</time>
</a>
                            
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

                    </div>
                    

                        

                                    <div class="article-entry" itemprop="articleBody">
                                        


                                            

                                                
                                                                    <h4 id="准备知识"><a href="#准备知识" class="headerlink" title="准备知识"></a>准备知识</h4><p>APP启动的时候是会去链接很多动态库，如UIKit，UIFoundation等。函数的调用是通过跳转指令跳到函数对应的内存地址，而动态库是在程序启动时才去链接的，因此动态库中函数的地址在一开始是不知道的，所以这些函数的地址存放在<strong>DATA,</strong>la_symbol_prt表中，也就是所谓的PIC(位置无关代码)。在函数第一次调用的时候例如NSLog()函数，这个表中的地址不是直接指向NSLog的正确地址，而是指向了dyld_stub_binder函数地址，它的作用就是去计算出NSLog的真正地址，然后将<strong>DATA,</strong>la_symbol_prt中NSLog对应的地址改为它的实际地址，这样第二次调用的时候就是直接调用到NSLog。另外除了<strong>la_symbol_prt表之外，还有与之对应的indirect Symbols、Symbol Table以及String Table。它们之间的关系是，**首先通过符号在</strong>la_symbol_prt的index，加上在Load Command中对__la_symbol_prt的描述信息reversed1，找到indirect Symbols中 index+reversed1 位置的数据index2，然后在找到Symbol Table中index2位置的数据拿到偏移地址offset，最后在String Table中找offset处的数据，该数据就是函数名”_NSLog”。**</p>
<p>fishhook是怎么hook懒加载和非懒加载的</p>
<h4 id="官方解释"><a href="#官方解释" class="headerlink" title="官方解释"></a>官方解释</h4><p><a href="https://github.com/facebook/fishhook" target="_blank" rel="noopener">https://github.com/facebook/fishhook</a></p>
<p>dyld binds lazy and non-lazy symbols by updating pointers in particular sections of the __DATA segment of a Mach-O binary. fishhook re-binds these symbols by determining the locations to update for each of the symbol names passed to rebind_symbols and then writing out the corresponding replacements.</p>
<p>For a given image, the <strong>DATA segment may contain two sections that are relevant for dynamic symbol bindings: </strong>nl_symbol_ptr and <strong>la_symbol_ptr. </strong>nl_symbol_ptr is an array of pointers to non-lazily bound data (these are bound at the time a library is loaded) and <strong>la_symbol_ptr is an array of pointers to imported functions that is generally filled by a routine called dyld_stub_binder during the first call to that symbol (it’s also possible to tell dyld to bind these at launch). In order to find the name of the symbol that corresponds to a particular location in one of these sections, we have to jump through several layers of indirection. For the two relevant sections, the section headers (struct sections from &lt;mach-o/loader.h&gt;) provide an offset (in the reserved1 field) into what is known as the indirect symbol table. The indirect symbol table, which is located in the </strong>LINKEDIT segment of the binary, is just an array of indexes into the symbol table (also in <strong>LINKEDIT) whose order is identical to that of the pointers in the non-lazy and lazy symbol sections. So, given struct section nl_symbol_ptr, the corresponding index in the symbol table of the first address in that section is indirect_symbol_table[nl_symbol_ptr-&gt;reserved1]. The symbol table itself is an array of struct nlists (see &lt;mach-o/nlist.h&gt;), and each nlist contains an index into the string table in </strong>LINKEDIT which where the actual symbol names are stored. So, for each pointer <strong>nl_symbol_ptr and </strong>la_symbol_ptr, we are able to find the corresponding symbol and then the corresponding string to compare against the requested symbol names, and if there is a match, we replace the pointer in the section with the replacement.</p>
<p>The process of looking up the name of a given entry in the lazy or non-lazy pointer tables looks like this: Visual explanation</p>
<p><img src="https://camo.githubusercontent.com/18243516844d12b1bd158ce3687635d6e48d2e2e/687474703a2f2f692e696d6775722e636f6d2f4856587148437a2e706e67" alt="image"></p>
<h4 id="代码解读"><a href="#代码解读" class="headerlink" title="代码解读"></a>代码解读</h4><ul>
<li><p>h 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * A structure representing a particular intended rebinding from a symbol</span><br><span class="line"> * name to its replacement</span><br><span class="line"> */</span><br><span class="line">struct rebinding &#123;</span><br><span class="line">  const char *name; // 函数名</span><br><span class="line">  void *replacement; // hook之后用于替换的函数</span><br><span class="line">  void **replaced; // 用于保存原来的函数地址，这里传递一个函数指针变量的地址进去</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * For each rebinding in rebindings, rebinds references to external, indirect</span><br><span class="line"> * symbols with the specified name to instead point at replacement for each</span><br><span class="line"> * image in the calling process as well as for all future images that are loaded</span><br><span class="line"> * by the process. If rebind_functions is called more than once, the symbols to</span><br><span class="line"> * rebind are added to the existing list of rebindings, and if a given symbol</span><br><span class="line"> * is rebound more than once, the later rebinding will take precedence.</span><br><span class="line"> */</span><br><span class="line">FISHHOOK_VISIBILITY</span><br><span class="line">int rebind_symbols(struct rebinding rebindings[], size_t rebindings_nel);</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * Rebinds as above, but only in the specified image. The header should point</span><br><span class="line"> * to the mach-o header, the slide should be the slide offset. Others as above.</span><br><span class="line"> */</span><br><span class="line">FISHHOOK_VISIBILITY</span><br><span class="line">int rebind_symbols_image(void *header,</span><br><span class="line">                         intptr_t slide,</span><br><span class="line">                         struct rebinding rebindings[],</span><br><span class="line">                         size_t rebindings_nel);</span><br></pre></td></tr></table></figure>
</li>
<li><p>c 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;fishhook.h&quot;</span><br><span class="line"></span><br><span class="line">#include &lt;dlfcn.h&gt;</span><br><span class="line">#include &lt;stdbool.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;sys/mman.h&gt;</span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;mach/mach.h&gt;</span><br><span class="line">#include &lt;mach/vm_map.h&gt;</span><br><span class="line">#include &lt;mach/vm_region.h&gt;</span><br><span class="line">#include &lt;mach-o/dyld.h&gt;</span><br><span class="line">#include &lt;mach-o/loader.h&gt;</span><br><span class="line">#include &lt;mach-o/nlist.h&gt;</span><br><span class="line"></span><br><span class="line">#ifdef __LP64__</span><br><span class="line">typedef struct mach_header_64 mach_header_t;</span><br><span class="line">typedef struct segment_command_64 segment_command_t;</span><br><span class="line">typedef struct section_64 section_t;</span><br><span class="line">typedef struct nlist_64 nlist_t;</span><br><span class="line">#define LC_SEGMENT_ARCH_DEPENDENT LC_SEGMENT_64</span><br><span class="line">#else</span><br><span class="line">typedef struct mach_header mach_header_t;</span><br><span class="line">typedef struct segment_command segment_command_t;</span><br><span class="line">typedef struct section section_t;</span><br><span class="line">typedef struct nlist nlist_t;</span><br><span class="line">#define LC_SEGMENT_ARCH_DEPENDENT LC_SEGMENT</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#ifndef SEG_DATA_CONST</span><br><span class="line">#define SEG_DATA_CONST  &quot;__DATA_CONST&quot;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">struct rebindings_entry &#123;</span><br><span class="line">  struct rebinding *rebindings;</span><br><span class="line">  size_t rebindings_nel;</span><br><span class="line">  struct rebindings_entry *next;// 下一个指针</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 链表表头</span><br><span class="line">static struct rebindings_entry *_rebindings_head;</span><br><span class="line"></span><br><span class="line">int rebind_symbols(struct rebinding rebindings[], size_t rebindings_nel) &#123;</span><br><span class="line">  int retval = prepend_rebindings(&amp;_rebindings_head, rebindings, rebindings_nel);</span><br><span class="line">  if (retval &lt; 0) &#123;</span><br><span class="line">    return retval;</span><br><span class="line">  &#125;</span><br><span class="line">  // If this was the first call, register callback for image additions (which is also invoked for</span><br><span class="line">  // existing images, otherwise, just run on existing images</span><br><span class="line">  if (!_rebindings_head-&gt;next) &#123;</span><br><span class="line">    // 这里只是注册了一个func，并没有调用所以不用考虑参数</span><br><span class="line">      /*</span><br><span class="line">      * The following functions allow you to install callbacks which will be called</span><br><span class="line">      * by dyld whenever an image is loaded or unloaded.  During a call to _dyld_register_func_for_add_image()</span><br><span class="line">      * the callback func is called for every existing image.  Later, it is called as each new image</span><br><span class="line">      * is loaded and bound (but initializers not yet run).  The callback registered with</span><br><span class="line">      * _dyld_register_func_for_remove_image() is called after any terminators in an image are run</span><br><span class="line">      * and before the image is un-memory-mapped.</span><br><span class="line">      */</span><br><span class="line">    _dyld_register_func_for_add_image(_rebind_symbols_for_image);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">      // 这里才是真正的调用</span><br><span class="line">    uint32_t c = _dyld_image_count();</span><br><span class="line">    for (uint32_t i = 0; i &lt; c; i++) &#123;</span><br><span class="line">      _rebind_symbols_for_image(_dyld_get_image_header(i), _dyld_get_image_vmaddr_slide(i));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static int prepend_rebindings(struct rebindings_entry **rebindings_head,</span><br><span class="line">                              struct rebinding rebindings[],</span><br><span class="line">                              size_t nel) &#123;</span><br><span class="line">  // 开辟新内存，C语言的标准写法</span><br><span class="line">  struct rebindings_entry *new_entry = (struct rebindings_entry *) malloc(sizeof(struct rebindings_entry));</span><br><span class="line">  // C语言开辟内存之后，必须校验是否开辟成功</span><br><span class="line">  if (!new_entry) &#123;</span><br><span class="line">    return -1;</span><br><span class="line">  &#125;</span><br><span class="line">    // C中数组的指针就是数组里第一个元素的指针</span><br><span class="line">  new_entry-&gt;rebindings = (struct rebinding *) malloc(sizeof(struct rebinding) * nel);</span><br><span class="line">  if (!new_entry-&gt;rebindings) &#123;</span><br><span class="line">    // malloc 内存不够需手动调整大小，内存释放需free，且free之后最好设为null</span><br><span class="line">    free(new_entry);</span><br><span class="line">    return -1;</span><br><span class="line">  &#125;</span><br><span class="line">    // 拷贝</span><br><span class="line">  memcpy(new_entry-&gt;rebindings, rebindings, sizeof(struct rebinding) * nel);</span><br><span class="line">  new_entry-&gt;rebindings_nel = nel;</span><br><span class="line">    </span><br><span class="line">    /*</span><br><span class="line">    第一次时 _rebindings_head 为null，即new_entry-&gt;next为null</span><br><span class="line">    然后将_rebindings_head 指向 当前的new_entry</span><br><span class="line">    第二次再来会新开辟内存生成new_entry2，注意由于_rebindings_head是static变量</span><br><span class="line">    _rebindings_head保留的是上次的new_entry，此时new_entry2-&gt;next即指向new_entry</span><br><span class="line">    */</span><br><span class="line">  new_entry-&gt;next = *rebindings_head;</span><br><span class="line">  *rebindings_head = new_entry;</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 函数指针 void (*funcp)(); 函数的指针</span><br><span class="line">// 指针函数 int * GetDate(int wk,int dy); 返回值是指针</span><br><span class="line">static void _rebind_symbols_for_image(const struct mach_header *header,</span><br><span class="line">                                      intptr_t slide) &#123;</span><br><span class="line">    rebind_symbols_for_image(_rebindings_head, header, slide);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static void rebind_symbols_for_image(struct rebindings_entry *rebindings,</span><br><span class="line">                                     const struct mach_header *header,</span><br><span class="line">                                     intptr_t slide) &#123;</span><br><span class="line">    // 地址符号信息</span><br><span class="line">  Dl_info info;</span><br><span class="line">    // dladdr 获取某个地址的符号信息</span><br><span class="line">  if (dladdr(header, &amp;info) == 0) &#123;</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">    // 因64位和32位的结构稍有不同，需要自定义</span><br><span class="line">  segment_command_t *cur_seg_cmd;</span><br><span class="line">  segment_command_t *linkedit_segment = NULL;</span><br><span class="line">  struct symtab_command* symtab_cmd = NULL; // 符号表</span><br><span class="line">  struct dysymtab_command* dysymtab_cmd = NULL; // 间接符号表</span><br><span class="line"></span><br><span class="line">    // 指向load Command的起始地址(uintptr_t)header。header是指针，</span><br><span class="line">    // header内存里存储的就是mach_header结构体的内存位置, 固强转long即可</span><br><span class="line">  uintptr_t cur = (uintptr_t)header + sizeof(mach_header_t);</span><br><span class="line">    // 遍历load command中所有的segment_command</span><br><span class="line">  for (uint i = 0; i &lt; header-&gt;ncmds; i++, cur += cur_seg_cmd-&gt;cmdsize) &#123;</span><br><span class="line">    </span><br><span class="line">    cur_seg_cmd = (segment_command_t *)cur;</span><br><span class="line">    if (cur_seg_cmd-&gt;cmd == LC_SEGMENT_ARCH_DEPENDENT) &#123;</span><br><span class="line">        /*</span><br><span class="line">         int strcmp(const char *str1, const char *str2)</span><br><span class="line">         如果返回值 &lt; 0，则表示 str1 小于 str2。</span><br><span class="line">         如果返回值 &gt; 0，则表示 str2 小于 str1。</span><br><span class="line">         如果返回值 = 0，则表示 str1 等于 str2。</span><br><span class="line">         */</span><br><span class="line">      if (strcmp(cur_seg_cmd-&gt;segname, SEG_LINKEDIT) == 0) &#123;</span><br><span class="line">        linkedit_segment = cur_seg_cmd;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else if (cur_seg_cmd-&gt;cmd == LC_SYMTAB) &#123;</span><br><span class="line">      symtab_cmd = (struct symtab_command*)cur_seg_cmd;</span><br><span class="line">    &#125; else if (cur_seg_cmd-&gt;cmd == LC_DYSYMTAB) &#123;</span><br><span class="line">      dysymtab_cmd = (struct dysymtab_command*)cur_seg_cmd;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (!symtab_cmd || !dysymtab_cmd || !linkedit_segment ||</span><br><span class="line">      !dysymtab_cmd-&gt;nindirectsyms) &#123;</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Find base symbol/string table addresses</span><br><span class="line">    //slide是ASLR的随机偏移，linkedit_segment-&gt;vmaddr - linkedit_segment-&gt;fileoff是mach-o在文件中的基地址，两者相加就是ASLR后的mach-o加载进内存的基地址</span><br><span class="line">  uintptr_t linkedit_base = (uintptr_t)slide + linkedit_segment-&gt;vmaddr - linkedit_segment-&gt;fileoff;</span><br><span class="line">    // Format of a symbol table entry of a Mach-O file</span><br><span class="line">  nlist_t *symtab = (nlist_t *)(linkedit_base + symtab_cmd-&gt;symoff);</span><br><span class="line">    // String Table的起始地址</span><br><span class="line">  char *strtab = (char *)(linkedit_base + symtab_cmd-&gt;stroff);</span><br><span class="line"></span><br><span class="line">  // Get indirect symbol table (array of uint32_t indices into symbol table)</span><br><span class="line">  uint32_t *indirect_symtab = (uint32_t *)(linkedit_base + dysymtab_cmd-&gt;indirectsymoff);</span><br><span class="line"></span><br><span class="line">  // 虽然上面所有的segment_command已经遍历完了，但header并没变，所以是第二次遍历load command</span><br><span class="line">  cur = (uintptr_t)header + sizeof(mach_header_t);</span><br><span class="line">  for (uint i = 0; i &lt; header-&gt;ncmds; i++, cur += cur_seg_cmd-&gt;cmdsize) &#123;</span><br><span class="line">    cur_seg_cmd = (segment_command_t *)cur;</span><br><span class="line">// #define    LC_SEGMENT    0x1    /* segment of this file to be mapped */</span><br><span class="line">    if (cur_seg_cmd-&gt;cmd == LC_SEGMENT_ARCH_DEPENDENT) &#123;</span><br><span class="line">      if (strcmp(cur_seg_cmd-&gt;segname, SEG_DATA) != 0 &amp;&amp;</span><br><span class="line">          strcmp(cur_seg_cmd-&gt;segname, SEG_DATA_CONST) != 0) &#123;</span><br><span class="line">        continue;</span><br><span class="line">      &#125;</span><br><span class="line">    // 遍历__DATA段的sections</span><br><span class="line">      for (uint j = 0; j &lt; cur_seg_cmd-&gt;nsects; j++) &#123;</span><br><span class="line">          // cur指向segment_command的起始地址需要偏移过去找到seciton的位置</span><br><span class="line">          // 不过 + j这个操作还是j惊艳到我了，毕竟是指针而不是section_t数组</span><br><span class="line">        section_t *sect =</span><br><span class="line">          (section_t *)(cur + sizeof(segment_command_t)) + j;</span><br><span class="line">          // 绑定懒加载 __la_symbol_ptr</span><br><span class="line">        if ((sect-&gt;flags &amp; SECTION_TYPE) == S_LAZY_SYMBOL_POINTERS) &#123;</span><br><span class="line">          perform_rebinding_with_section(rebindings, sect, slide, symtab, strtab, indirect_symtab);</span><br><span class="line">        &#125;</span><br><span class="line">          // 绑定非懒加载 __nl_symbol_ptr</span><br><span class="line">        if ((sect-&gt;flags &amp; SECTION_TYPE) == S_NON_LAZY_SYMBOL_POINTERS) &#123;</span><br><span class="line">          perform_rebinding_with_section(rebindings, sect, slide, symtab, strtab, indirect_symtab);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static vm_prot_t get_protection(void *sectionStart) &#123;</span><br><span class="line">  mach_port_t task = mach_task_self();</span><br><span class="line">  vm_size_t size = 0;</span><br><span class="line">  vm_address_t address = (vm_address_t)sectionStart;</span><br><span class="line">  memory_object_name_t object;</span><br><span class="line">#if __LP64__</span><br><span class="line">  mach_msg_type_number_t count = VM_REGION_BASIC_INFO_COUNT_64;</span><br><span class="line">  vm_region_basic_info_data_64_t info;</span><br><span class="line">  kern_return_t info_ret = vm_region_64(</span><br><span class="line">      task, &amp;address, &amp;size, VM_REGION_BASIC_INFO_64, (vm_region_info_64_t)&amp;info, &amp;count, &amp;object);</span><br><span class="line">#else</span><br><span class="line">  mach_msg_type_number_t count = VM_REGION_BASIC_INFO_COUNT;</span><br><span class="line">  vm_region_basic_info_data_t info;</span><br><span class="line">  kern_return_t info_ret = vm_region(task, &amp;address, &amp;size, VM_REGION_BASIC_INFO, (vm_region_info_t)&amp;info, &amp;count, &amp;object);</span><br><span class="line">#endif</span><br><span class="line">  if (info_ret == KERN_SUCCESS) &#123;</span><br><span class="line">    return info.protection;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return VM_PROT_READ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static void perform_rebinding_with_section(struct rebindings_entry *rebindings,</span><br><span class="line">                                           section_t *section, // 节点</span><br><span class="line">                                           intptr_t slide, // ASLR的偏移量</span><br><span class="line">                                           nlist_t *symtab,</span><br><span class="line">                                           char *strtab,</span><br><span class="line">                                           uint32_t *indirect_symtab) &#123;</span><br><span class="line">    </span><br><span class="line">  const bool isDataConst = strcmp(section-&gt;segname, &quot;__DATA_CONST&quot;) == 0;</span><br><span class="line">    // indirect Symbols中包含了各个section中符号在Symbol Table的index，</span><br><span class="line">    // 这里是直接定位到对应__DATA,__la_symbol_ptr所在的index数组</span><br><span class="line">  uint32_t *indirect_symbol_indices = indirect_symtab + section-&gt;reserved1;</span><br><span class="line">    // void** ？？？void * 为 “无类型指针”，即可以指向任何类型</span><br><span class="line">  void **indirect_symbol_bindings = (void **)((uintptr_t)slide + section-&gt;addr);</span><br><span class="line">    </span><br><span class="line">    /* read permission */</span><br><span class="line">  vm_prot_t oldProtection = VM_PROT_READ;</span><br><span class="line">    </span><br><span class="line">    // 常量</span><br><span class="line">  if (isDataConst) &#123;</span><br><span class="line">    oldProtection = get_protection(rebindings);</span><br><span class="line">      // mprotect()函数可以用来修改一段指定内存区域的保护属性。</span><br><span class="line">    mprotect(indirect_symbol_bindings, section-&gt;size, PROT_READ | PROT_WRITE);</span><br><span class="line">  &#125;</span><br><span class="line">  for (uint i = 0; i &lt; section-&gt;size / sizeof(void *); i++) &#123;</span><br><span class="line">      </span><br><span class="line">    uint32_t symtab_index = indirect_symbol_indices[i];</span><br><span class="line">      </span><br><span class="line">      /*</span><br><span class="line">      * An indirect symbol table entry is simply a 32bit index into the symbol table</span><br><span class="line">      * to the symbol that the pointer or stub is refering to.  Unless it is for a</span><br><span class="line">      * non-lazy symbol pointer section for a defined symbol which strip(1) as</span><br><span class="line">      * removed.  In which case it has the value INDIRECT_SYMBOL_LOCAL.  If the</span><br><span class="line">      * symbol was also absolute INDIRECT_SYMBOL_ABS is or&apos;ed with that.</span><br><span class="line">      */</span><br><span class="line">    if (symtab_index == INDIRECT_SYMBOL_ABS || symtab_index == INDIRECT_SYMBOL_LOCAL ||</span><br><span class="line">        symtab_index == (INDIRECT_SYMBOL_LOCAL   | INDIRECT_SYMBOL_ABS)) &#123;</span><br><span class="line">      continue;</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">      // index into the string table, String Table中的偏移量</span><br><span class="line">    uint32_t strtab_offset = symtab[symtab_index].n_un.n_strx;</span><br><span class="line">      // 起始地址 + 偏移量 = 符号名</span><br><span class="line">    char *symbol_name = strtab + strtab_offset;</span><br><span class="line">      // symbol_name[0]一般是 _ 下划线, symbol_name[1] 是函数名</span><br><span class="line">    bool symbol_name_longer_than_1 = symbol_name[0] &amp;&amp; symbol_name[1];</span><br><span class="line">      </span><br><span class="line">    struct rebindings_entry *cur = rebindings;</span><br><span class="line">    while (cur) &#123;</span><br><span class="line">        // 遍历需要绑定的函数</span><br><span class="line">      for (uint j = 0; j &lt; cur-&gt;rebindings_nel; j++) &#123;</span><br><span class="line">       //编译的时候会将符号转成带下划线的，比如printf会转成_printf,所以从下划线后面的字符开始比较</span><br><span class="line">        if (symbol_name_longer_than_1 &amp;&amp;</span><br><span class="line">            strcmp(&amp;symbol_name[1], cur-&gt;rebindings[j].name) == 0) &#123;</span><br><span class="line">          if (cur-&gt;rebindings[j].replaced != NULL &amp;&amp;</span><br><span class="line">              indirect_symbol_bindings[i] != cur-&gt;rebindings[j].replacement) &#123;</span><br><span class="line">              // 保存原来的函数地址</span><br><span class="line">            *(cur-&gt;rebindings[j].replaced) = indirect_symbol_bindings[i];</span><br><span class="line">          &#125;</span><br><span class="line">            // 替换成新的函数实现</span><br><span class="line">          indirect_symbol_bindings[i] = cur-&gt;rebindings[j].replacement;</span><br><span class="line">            // 退出遍历，即针对同一符号多次调用fishhook重绑定，只有会对最后一次调用的生效</span><br><span class="line">          goto symbol_loop;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      cur = cur-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">  symbol_loop:;</span><br><span class="line">  &#125;</span><br><span class="line">  if (isDataConst) &#123;</span><br><span class="line">    int protection = 0;</span><br><span class="line">    if (oldProtection &amp; VM_PROT_READ) &#123;</span><br><span class="line">      protection |= PROT_READ;</span><br><span class="line">    &#125;</span><br><span class="line">    if (oldProtection &amp; VM_PROT_WRITE) &#123;</span><br><span class="line">      protection |= PROT_WRITE;</span><br><span class="line">    &#125;</span><br><span class="line">    if (oldProtection &amp; VM_PROT_EXECUTE) &#123;</span><br><span class="line">      protection |= PROT_EXEC;</span><br><span class="line">    &#125;</span><br><span class="line">    mprotect(indirect_symbol_bindings, section-&gt;size, protection);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int rebind_symbols_image(void *header,</span><br><span class="line">                         intptr_t slide,</span><br><span class="line">                         struct rebinding rebindings[],</span><br><span class="line">                         size_t rebindings_nel) &#123;</span><br><span class="line">    struct rebindings_entry *rebindings_head = NULL;</span><br><span class="line">    int retval = prepend_rebindings(&amp;rebindings_head, rebindings, rebindings_nel);</span><br><span class="line">    rebind_symbols_for_image(rebindings_head, (const struct mach_header *) header, slide);</span><br><span class="line">    if (rebindings_head) &#123;</span><br><span class="line">      free(rebindings_head-&gt;rebindings);</span><br><span class="line">    &#125;</span><br><span class="line">    free(rebindings_head);</span><br><span class="line">    return retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>

                                                                        
                                    </div>
                                    <footer class="article-footer">
                                        <a data-url="http://jiaozhengkui.top/2017/10/10/FishHook都干了什么/" data-id="ckd90jokl001gxc51nr3aukwt" class="article-share-link">
                                            Share
                                        </a>
                                        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/原创/">原创</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/原理/">原理</a></li></ul>

                                    </footer>

    </div>

    

                

</article>
        
          <article id="post-otool命令" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

    <div class="article-inner">
        
            <header class="article-header">
                
  
    <h2 itemprop="name">
      <a class="article-title" href="/2017/10/09/otool命令/">otool命令</a>
    </h2>
  
  




            </header>
            

                
                    <div class="article-meta">
                        <a href="/2017/10/09/otool命令/" class="article-date">
  <time datetime="2017-10-09T10:14:18.000Z" itemprop="datePublished">2017-10-09</time>
</a>
                            
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

                    </div>
                    

                        

                                    <div class="article-entry" itemprop="articleBody">
                                        


                                            

                                                
                                                                    <h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1 简介"></a>1 简介</h3><p>&emsp;&emsp;Otool可以提取并显示ios下目标文件的相关信息，包括头部、加载命令、各个段、共享库、动态库等。Otool拥有大量的命令选项，是一个功能强大的分析工具，也可以反汇编！常用于逆向工程，这里不写逆向工程，就写点otool命令</p>
<p>&emsp;&emsp;第一个命令永远是help，但刚开头就卡壳了！无论otool -h，还是otool -help，都会提示错误。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/otool: at least one file must be specified</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;我想破脑袋也没想明白怎么会这样？典型的反人类设计！不过还是可以看到相关的命令解释的！更新：otool+回车，才是正确的help命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Usage: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/otool [-arch arch_type] [-fahlLDtdorSTMRIHGvVcXmqQjCP] [-mcpu=arg] [--version] &lt;object file&gt; ...</span><br><span class="line">-f print the fat headers</span><br><span class="line">-a print the archive header</span><br><span class="line">-h print the mach header</span><br><span class="line">-l print the load commands</span><br><span class="line">-L print shared libraries used</span><br><span class="line">-D print shared library id name</span><br><span class="line">-t print the text section (disassemble with -v)</span><br><span class="line">-p &lt;routine name&gt;  start dissassemble from routine name</span><br><span class="line">-s &lt;segname&gt; &lt;sectname&gt; print contents of section</span><br><span class="line">-d print the data section</span><br><span class="line">-o print the Objective-C segment</span><br><span class="line">-r print the relocation entries</span><br><span class="line">-S print the table of contents of a library (obsolete)</span><br><span class="line">-T print the table of contents of a dynamic shared library (obsolete)</span><br><span class="line">-M print the module table of a dynamic shared library (obsolete)</span><br><span class="line">-R print the reference table of a dynamic shared library (obsolete)</span><br><span class="line">-I print the indirect symbol table</span><br><span class="line">-H print the two-level hints table (obsolete)</span><br><span class="line">-G print the data in code table</span><br><span class="line">-v print verbosely (symbolically) when possible</span><br><span class="line">-V print disassembled operands symbolically</span><br><span class="line">-c print argument strings of a core file</span><br><span class="line">-X print no leading addresses or headers</span><br><span class="line">-m don&apos;t use archive(member) syntax</span><br><span class="line">-B force Thumb disassembly (ARM objects only)</span><br><span class="line">-q use llvm&apos;s disassembler (the default)</span><br><span class="line">-Q use otool(1)&apos;s disassembler</span><br><span class="line">-mcpu=arg use `arg&apos; as the cpu for disassembly</span><br><span class="line">-j print opcode bytes</span><br><span class="line">-P print the info plist section as strings</span><br><span class="line">-C print linker optimization hints</span><br><span class="line">--version print the version of /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/otool</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;由上可知</p>
<ol>
<li>otool地址：/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/otool 前往bin目录得知otool其实是llvm-otool。bin目录下还有很多工具，我似乎看到了好多水文在向我招手，嘿嘿…</li>
<li>使用方式： otool [-arch arch_type] [-fahlLDtdorSTMRIHGvVcXmqQjCP] [-mcpu=arg] [–version] <object file> …</object></li>
</ol>
<h3 id="2-常用命令"><a href="#2-常用命令" class="headerlink" title="2 常用命令"></a>2 常用命令</h3><ul>
<li><p>查看Mach-O头结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">otool -v -h a.out</span><br><span class="line">otool -h xxx.app/xxx</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看load commands</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">otool -v -l a.out</span><br><span class="line">otool -l xxx.app/xxx</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看Objective-C segment</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">otool -o xxx.app/xxx</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看Section中的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 查看__TEXT segname的 __text段</span><br><span class="line">otool -s __TEXT __text a.out </span><br><span class="line">// 由于 -s __TEXT __text 很常见，otool 对其设置了一个缩写 -t</span><br><span class="line">otool -t a.out</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加 -v 来查看反汇编代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 查看反汇编之后的__TEXT segname的 __text段</span><br><span class="line">otool -v -t xxx.app/xxx</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取所有方法名称</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">otool -v -s __TEXT __objc_methname xxx.app/xxx</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看依赖的动态库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">otool -L xxx.app/xxx</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看支持的框架</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">otool -D xxx.app/xxx</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看该应用是否加壳</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">otool -l xxx.app/xxx | grep -B 2 crypt</span><br><span class="line">// cryptid 0（砸壳） 1（未砸壳）</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="3-常见的Section"><a href="#3-常见的Section" class="headerlink" title="3 常见的Section"></a>3 常见的Section</h3><p>&emsp;&emsp;<a href="https://developer.apple.com/library/mac/documentation/DeveloperTools/Reference/Assembler/" target="_blank" rel="noopener">更多Section介绍</a></p>
<table>
<thead>
<tr>
<th>Section</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>TEXT.</strong>text</td>
<td>主程序代码</td>
</tr>
<tr>
<td><strong>TEXT.</strong>cstring</td>
<td>C 语言字符串</td>
</tr>
<tr>
<td><strong>TEXT.</strong>const</td>
<td>const 关键字修饰的常量</td>
</tr>
<tr>
<td><strong>TEXT.</strong>stubs</td>
<td>用于 Stub 的占位代码，很多地方称之为桩代码。</td>
</tr>
<tr>
<td><strong>TEXT.</strong>stubs_helper</td>
<td>当 Stub 无法找到真正的符号地址后的最终指向</td>
</tr>
<tr>
<td><strong>TEXT.</strong>objc_methname</td>
<td>Objective-C 方法名称</td>
</tr>
<tr>
<td><strong>TEXT.</strong>objc_methtype</td>
<td>Objective-C 方法类型</td>
</tr>
<tr>
<td><strong>TEXT.</strong>objc_classname</td>
<td>Objective-C 类名称</td>
</tr>
<tr>
<td><strong>DATA.</strong>data</td>
<td>初始化过的可变数据</td>
</tr>
<tr>
<td><strong>DATA.</strong>la_symbol_ptr</td>
<td>lazy binding 的指针表，表中的指针一开始都指向 __stub_helper</td>
</tr>
<tr>
<td>__DATA.nl_symbol_ptr</td>
<td>非 lazy binding 的指针表，每个表项中的指针都指向一个在装载过程中，被动态链机器搜索完成的符号</td>
</tr>
<tr>
<td><strong>DATA.</strong>const</td>
<td>没有初始化过的常量</td>
</tr>
<tr>
<td><strong>DATA.</strong>cfstring</td>
<td>程序中使用的 Core Foundation 字符串（CFStringRefs）</td>
</tr>
<tr>
<td><strong>DATA.</strong>bss</td>
<td>BSS，存放为初始化的全局变量，即常说的静态内存分配</td>
</tr>
<tr>
<td><strong>DATA.</strong>common</td>
<td>没有初始化过的符号声明</td>
</tr>
<tr>
<td><strong>DATA.</strong>objc_classlist</td>
<td>Objective-C 类列表</td>
</tr>
<tr>
<td><strong>DATA.</strong>objc_protolist</td>
<td>Objective-C 原型</td>
</tr>
<tr>
<td><strong>DATA.</strong>objc_imginfo</td>
<td>Objective-C 镜像信息</td>
</tr>
<tr>
<td><strong>DATA.</strong>objc_selfrefs</td>
<td>Objective-C self 引用</td>
</tr>
<tr>
<td><strong>DATA.</strong>objc_protorefs</td>
<td>Objective-C 原型引用</td>
</tr>
<tr>
<td><strong>DATA.</strong>objc_superrefs</td>
<td>Objective-C 超类引用</td>
</tr>
</tbody>
</table>

                                                                        
                                    </div>
                                    <footer class="article-footer">
                                        <a data-url="http://jiaozhengkui.top/2017/10/09/otool命令/" data-id="ckd90jom60055xc51c4cit9i4" class="article-share-link">
                                            Share
                                        </a>
                                        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/原创/">原创</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/编译/">编译</a></li></ul>

                                    </footer>

    </div>

    

                

</article>
        
    </article>
    
  
    
      <nav class="page-nav">
        <a class="extend prev" rel="prev" href="/">Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/3/">Next</a>
      </nav>
    
  </section>
</div>

  <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
    <li><i class="fe fe-bar-chart"></i> <span id="busuanzi_value_site_pv"></span></li>
  
    <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>&copy; 2020 焦正奎的博客</li>
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>Theme  <a href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>

</main>
<aside class="sidebar">
  <button class="navbar-toggle"></button>
<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/author.jpg" alt="焦正奎的博客"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">Home</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/archives">Archives</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/gallery">Gallery</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/about">About</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="Search">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
        <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
          <i class="fe fe-feed"></i>
        </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
</aside>
<script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/lazyload.min.js"></script>
<script src="/js/busuanzi-2.3.pure.min.js"></script>

  <script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/ocean.js"></script>

</body>
</html>